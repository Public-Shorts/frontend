import{p as At,o as Lt,f as kt,j as Nt,t as jt,b as Vt,a as Ft,l as V,s as Oe,z as Ae,c as Le,a9 as Ut,A as ke,ab as Gt,u as Ne}from"./iframe-6KIpb0Mt.js";import{g as zt,s as Jt}from"./create-runtime-stories-C7cqMwQp.js";import{b as Ht}from"./this-DkeGxGfh.js";import{g as qt}from"./_commonjsHelpers-CqkleIqs.js";import"./preload-helper-PPVm8Dsz.js";function Wt(n,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const i in r)if(i!=="default"&&!(i in n)){const a=Object.getOwnPropertyDescriptor(r,i);a&&Object.defineProperty(n,i,a.get?a:{enumerable:!0,get:()=>r[i]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}const je={};var w=(function(n){if(typeof define=="function"&&define.amd)define(n);else if(typeof module=="object"&&module.exports)module.exports=n();else if(typeof window=="object")return n()})(function(){e.sessions=new Map,e.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let t=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),r=33;return window.navigator.userAgent.match("Linux")&&(r=35),t>=26&&t<=r?!0:e.extension.isInstalled()}else return!0};var n={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return document.querySelector("#janus-extension-installed")!==null},getScreen:function(t){let r=window.setTimeout(function(){let i=new Error("NavigatorUserMediaError");return i.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',t(i)},1e3);this.cache[r]=t,window.postMessage({type:"janusGetScreen",id:r},"*")},init:function(){let t={};this.cache=t,window.addEventListener("message",function(r){if(r.origin==window.location.origin)if(r.data.type=="janusGotScreen"&&t[r.data.id]){let i=t[r.data.id];if(delete t[r.data.id],r.data.sourceId===""){let a=new Error("NavigatorUserMediaError");a.name="You cancelled the request for permission, giving up...",i(a)}else i(null,r.data.sourceId)}else r.data.type=="janusGetScreenPending"&&window.clearTimeout(r.data.id)})}};e.useDefaultDependencies=function(t){let r=t&&t.fetch||fetch,i=t&&t.Promise||Promise,a=t&&t.WebSocket||WebSocket;return{newWebSocket:function(f,d){return new a(f,d)},extension:t&&t.extension||n,isArray:function(f){return Array.isArray(f)},webRTCAdapter:t&&t.adapter||adapter,httpAPICall:function(f,d){let S={method:d.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};d.verb==="POST"&&(S.headers["Content-Type"]="application/json"),typeof d.withCredentials<"u"&&(S.credentials=d.withCredentials===!0?"include":d.withCredentials?d.withCredentials:"omit"),d.body&&(S.body=JSON.stringify(d.body));let m=r(f,S).catch(function(y){return i.reject({message:"Probably a network error, is the server down?",error:y})});if(d.timeout){let y=new i(function(b,P){let _=setTimeout(function(){return clearTimeout(_),P({message:"Request timed out",timeout:d.timeout})},d.timeout)});m=i.race([m,y])}return m.then(function(y){if(y.ok){if(typeof d.success==typeof e.noop)return y.json().then(function(b){try{d.success(b)}catch(P){e.error("Unhandled httpAPICall success callback error",P)}},function(b){return i.reject({message:"Failed to parse response body",error:b,response:y})})}else return i.reject({message:"API call failed",response:y})}).catch(function(y){typeof d.error==typeof e.noop&&d.error(y.message||"<< internal error >>",y)}),m}}},e.useOldDependencies=function(t){let r=t&&t.jQuery||jQuery,i=t&&t.WebSocket||WebSocket;return{newWebSocket:function(a,f){return new i(a,f)},isArray:function(a){return r.isArray(a)},extension:t&&t.extension||n,webRTCAdapter:t&&t.adapter||adapter,httpAPICall:function(a,f){let d=typeof f.body<"u"?{contentType:"application/json",data:JSON.stringify(f.body)}:{},S=typeof f.withCredentials<"u"?{xhrFields:{withCredentials:f.withCredentials}}:{};return r.ajax(r.extend(d,S,{url:a,type:f.verb,cache:!1,dataType:"json",async:f.async,timeout:f.timeout,success:function(m){typeof f.success==typeof e.noop&&f.success(m)},error:function(m,y,b){typeof f.error==typeof e.noop&&f.error(y,b)}}))}}},e.mediaToTracks=function(t){let r=[];if(!t)r.push({type:"audio",capture:!0,recv:!0}),r.push({type:"video",capture:!0,recv:!0});else{if(!t.keepAudio&&t.audio!==!1&&(typeof t.audio>"u"||t.audio||t.audioSend||t.audioRecv||t.addAudio||t.replaceAudio||t.removeAudio)){let i={type:"audio"};t.removeAudio?i.remove=!0:(t.addAudio?i.add=!0:t.replaceAudio&&(i.replace=!0),t.audioSend!==!1&&(i.capture=t.audio||!0),t.audioRecv!==!1&&(i.recv=!0)),(i.remove||i.capture||i.recv)&&r.push(i)}if(!t.keepVideo&&t.video!==!1&&(typeof t.video>"u"||t.video||t.videoSend||t.videoRecv||t.addVideo||t.replaceVideo||t.removeVideo)){let i={type:"video"};t.removeVideo?i.remove=!0:(t.addVideo?i.add=!0:t.replaceVideo&&(i.replace=!0),t.videoSend!==!1&&(i.capture=t.video||!0,["screen","window","desktop"].includes(i.capture)&&(i.type="screen",i.capture={video:{}},t.screenshareFrameRate&&(i.capture.frameRate=t.screenshareFrameRate),t.screenshareHeight&&(i.capture.height=t.screenshareHeight),t.screenshareWidth&&(i.capture.width=t.screenshareWidth))),t.videoRecv!==!1&&(i.recv=!0)),(i.remove||i.capture||i.recv)&&r.push(i)}t.data&&r.push({type:"data"})}return r},e.trackConstraints=function(t){let r={};if(!t||!t.capture)return r;if(t.type==="audio")r.audio=t.capture;else if(t.type==="video")if((t.simulcast||t.svc)&&t.capture===!0&&(t.capture="hires"),t.capture===!0||typeof t.capture=="object")r.video=t.capture;else{let i=0,a=0;t.capture==="lowres"?(i=320,a=240):t.capture==="lowres-16:9"?(i=320,a=180):t.capture==="hires"||t.capture==="hires-16:9"||t.capture==="hdres"?(i=1280,a=720):t.capture==="fhdres"?(i=1920,a=1080):t.capture==="4kres"?(i=3840,a=2160):t.capture==="stdres"?(i=640,a=480):t.capture==="stdres-16:9"?(i=640,a=360):(e.log("Default video setting is stdres 4:3"),i=640,a=480),r.video={width:{ideal:i},height:{ideal:a}}}else t.type==="screen"&&(r.video=t.capture);return r},e.noop=function(){},e.dataChanDefaultLabel="JanusDataChannel",e.endOfCandidates=null,e.stopAllTracks=function(t){try{let r=t.getTracks();for(let i of r)e.log(i),i&&i.dontStop!==!0&&i.stop()}catch{}},e.init=function(t){if(t=t||{},t.callback=typeof t.callback=="function"?t.callback:e.noop,e.initDone)t.callback();else{if(typeof console.log>"u"&&(console.log=function(){}),e.trace=e.noop,e.debug=e.noop,e.vdebug=e.noop,e.log=e.noop,e.warn=e.noop,e.error=e.noop,t.debug===!0||t.debug==="all")e.trace=console.trace.bind(console),e.debug=console.debug.bind(console),e.vdebug=console.debug.bind(console),e.log=console.log.bind(console),e.warn=console.warn.bind(console),e.error=console.error.bind(console);else if(Array.isArray(t.debug))for(let d of t.debug)switch(d){case"trace":e.trace=console.trace.bind(console);break;case"debug":e.debug=console.debug.bind(console);break;case"vdebug":e.vdebug=console.debug.bind(console);break;case"log":e.log=console.log.bind(console);break;case"warn":e.warn=console.warn.bind(console);break;case"error":e.error=console.error.bind(console);break}e.log("Initializing library");let r=t.dependencies||e.useDefaultDependencies();e.isArray=r.isArray,e.webRTCAdapter=r.webRTCAdapter,e.httpAPICall=r.httpAPICall,e.newWebSocket=r.newWebSocket,e.extension=r.extension,e.extension.init(),e.listDevices=function(d,S){d=typeof d=="function"?d:e.noop,S||(S={audio:!0,video:!0}),e.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(S).then(function(m){navigator.mediaDevices.enumerateDevices().then(function(y){e.debug(y),d(y),e.stopAllTracks(m)})}).catch(function(m){e.error(m),d([])}):(e.warn("navigator.mediaDevices unavailable"),d([]))},e.attachMediaStream=function(d,S){try{d.srcObject=S}catch{try{d.src=URL.createObjectURL(S)}catch(y){e.error("Error attaching stream to element",y)}}},e.reattachMediaStream=function(d,S){try{d.srcObject=S.srcObject}catch{try{d.src=S.src}catch(y){e.error("Error reattaching stream to element",y)}}};let a=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",f=window["on"+a];if(window.addEventListener(a,function(){e.log("Closing window");for(const[d,S]of e.sessions)S&&S.destroyOnUnload&&(e.log("Destroying session "+d),S.destroy({unload:!0,notifyDestroyed:!1}));f&&typeof f=="function"&&f()}),e.safariVp8=!1,e.safariVp9=!1,e.webRTCAdapter.browserDetails.browser==="safari"&&e.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(let d of RTCRtpSender.getCapabilities("video").codecs)d&&d.mimeType&&d.mimeType.toLowerCase()==="video/vp8"?e.safariVp8=!0:d&&d.mimeType&&d.mimeType.toLowerCase()==="video/vp9"&&(e.safariVp9=!0);e.safariVp8?e.log("This version of Safari supports VP8"):e.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let d=new RTCPeerConnection({});d.createOffer({offerToReceiveVideo:!0}).then(function(S){e.safariVp8=S.sdp.indexOf("VP8")!==-1,e.safariVp9=S.sdp.indexOf("VP9")!==-1,e.safariVp8?e.log("This version of Safari supports VP8"):e.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),d.close(),d=null})}e.initDone=!0,t.callback()}},e.isWebrtcSupported=function(){return!!window.RTCPeerConnection},e.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},e.randomString=function(t){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i="";for(let a=0;a<t;a++){let f=Math.floor(Math.random()*r.length);i+=r.charAt(f)}return i};function e(t){if(t=t||{},t.success=typeof t.success=="function"?t.success:e.noop,t.error=typeof t.error=="function"?t.error:e.noop,t.destroyed=typeof t.destroyed=="function"?t.destroyed:e.noop,!e.initDone)return t.error("Library not initialized"),{};if(!e.isWebrtcSupported())return t.error("WebRTC not supported by this browser"),{};if(e.log("Library initialized: "+e.initDone),!t.server)return t.error("Invalid server url"),{};let r=!1,i=null,a={},f=null,d=null,S=0,m=t.server;e.isArray(m)?(e.log("Multiple servers provided ("+m.length+"), will use the first that works"),m=null,d=t.server,e.debug(d)):m.indexOf("ws")===0?(r=!0,e.log("Using WebSockets to contact Janus: "+m)):(r=!1,e.log("Using REST API to contact Janus: "+m));let y=t.iceServers||[{urls:"stun:stun.l.google.com:19302"}],b=t.iceTransportPolicy,P=t.bundlePolicy,_=!1;typeof t.withCredentials<"u"&&t.withCredentials!==null&&(_=t.withCredentials===!0);let I=10;typeof t.max_poll_events<"u"&&t.max_poll_events!==null&&(I=t.max_poll_events),I<1&&(I=1);let A=null;typeof t.token<"u"&&t.token!==null&&(A=t.token);let k=null;typeof t.apisecret<"u"&&t.apisecret!==null&&(k=t.apisecret),this.destroyOnUnload=!0,typeof t.destroyOnUnload<"u"&&t.destroyOnUnload!==null&&(this.destroyOnUnload=t.destroyOnUnload===!0);let U=25e3;typeof t.keepAlivePeriod<"u"&&t.keepAlivePeriod!==null&&(U=t.keepAlivePeriod),isNaN(U)&&(U=25e3);let B=6e4;typeof t.longPollTimeout<"u"&&t.longPollTimeout!==null&&(B=t.longPollTimeout),isNaN(B)&&(B=6e4);function Rt(o){let c={high:9e5,medium:3e5,low:1e5};return typeof o<"u"&&o!==null&&(o.high&&(c.high=o.high),o.medium&&(c.medium=o.medium),o.low&&(c.low=o.low)),c}let N=!1,D=null,M=new Map,$=this,ie=0,F=new Map;Q(t),this.getServer=function(){return m},this.isConnected=function(){return N},this.reconnect=function(o){o=o||{},o.success=typeof o.success=="function"?o.success:e.noop,o.error=typeof o.error=="function"?o.error:e.noop,o.reconnect=!0,Q(o)},this.getSessionId=function(){return D},this.getInfo=function(o){Pt(o)},this.destroy=function(o){bt(o)},this.attach=function(o){Et(o)};function oe(){if(D==null)return;if(e.debug("Long poll..."),!N){e.warn("Is the server down? (connected=false)");return}let o=m+"/"+D+"?rid="+new Date().getTime();I&&(o=o+"&maxev="+I),A&&(o=o+"&token="+encodeURIComponent(A)),k&&(o=o+"&apisecret="+encodeURIComponent(k)),e.httpAPICall(o,{verb:"GET",withCredentials:_,success:se,timeout:B,error:function(c,u){if(e.error(c+":",u),ie++,ie>3){N=!1,t.error("Lost connection to the server (is it down?)");return}oe()}})}function se(o,c){if(ie=0,!r&&typeof D<"u"&&D!==null&&c!==!0&&oe(),!r&&e.isArray(o)){for(let u=0;u<o.length;u++)se(o[u],!0);return}if(o.janus==="keepalive"){e.vdebug("Got a keepalive on session "+D);return}else if(o.janus==="server_info"){e.debug("Got info on the Janus instance"),e.debug(o);const u=o.transaction;if(u){const s=F.get(u);s&&s(o),F.delete(u)}return}else if(o.janus==="ack"){e.debug("Got an ack on session "+D),e.debug(o);const u=o.transaction;if(u){const s=F.get(u);s&&s(o),F.delete(u)}return}else if(o.janus==="success"){e.debug("Got a success on session "+D),e.debug(o);const u=o.transaction;if(u){const s=F.get(u);s&&s(o),F.delete(u)}return}else if(o.janus==="trickle"){const u=o.sender;if(!u){e.warn("Missing sender...");return}const s=M.get(u);if(!s){e.debug("This handle is not attached to this session");return}let g=o.candidate;e.debug("Got a trickled candidate on session "+D),e.debug(g);let h=s.webrtcStuff;h.pc&&h.remoteSdp?(e.debug("Adding remote candidate:",g),!g||g.completed===!0?h.pc.addIceCandidate(e.endOfCandidates):h.pc.addIceCandidate(g)):(e.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),h.candidates||(h.candidates=[]),h.candidates.push(g),e.debug(h.candidates))}else if(o.janus==="webrtcup"){e.debug("Got a webrtcup event on session "+D),e.debug(o);const u=o.sender;if(!u){e.warn("Missing sender...");return}const s=M.get(u);if(!s){e.debug("This handle is not attached to this session");return}s.webrtcState(!0);return}else if(o.janus==="hangup"){e.debug("Got a hangup event on session "+D),e.debug(o);const u=o.sender;if(!u){e.warn("Missing sender...");return}const s=M.get(u);if(!s){e.debug("This handle is not attached to this session");return}s.webrtcState(!1,o.reason),s.hangup()}else if(o.janus==="detached"){e.debug("Got a detached event on session "+D),e.debug(o);const u=o.sender;if(!u){e.warn("Missing sender...");return}const s=M.get(u);if(!s)return;s.ondetached(),s.detach()}else if(o.janus==="media"){e.debug("Got a media event on session "+D),e.debug(o);const u=o.sender;if(!u){e.warn("Missing sender...");return}const s=M.get(u);if(!s){e.debug("This handle is not attached to this session");return}s.mediaState(o.type,o.receiving,o.mid)}else if(o.janus==="slowlink"){e.debug("Got a slowlink event on session "+D),e.debug(o);const u=o.sender;if(!u){e.warn("Missing sender...");return}const s=M.get(u);if(!s){e.debug("This handle is not attached to this session");return}s.slowLink(o.uplink,o.lost,o.mid)}else if(o.janus==="error"){e.error("Ooops: "+o.error.code+" "+o.error.reason),e.debug(o);let u=o.transaction;if(u){let s=F.get(u);s&&s(o),F.delete(u)}return}else if(o.janus==="event"){e.debug("Got a plugin event on session "+D),e.debug(o);const u=o.sender;if(!u){e.warn("Missing sender...");return}let s=o.plugindata;if(!s){e.warn("Missing plugindata...");return}e.debug("  -- Event is coming from "+u+" ("+s.plugin+")");let g=s.data;e.debug(g);const h=M.get(u);if(!h){e.warn("This handle is not attached to this session");return}let l=o.jsep;l&&(e.debug("Handling SDP as well..."),e.debug(l));let R=h.onmessage;R?(e.debug("Notifying application..."),R(g,l)):e.debug("No provided notification callback")}else if(o.janus==="timeout"){e.error("Timeout on session "+D),e.debug(o),r&&i.close(3504,"Gateway timeout");return}else e.warn("Unknown message/event  '"+o.janus+"' on session "+D),e.debug(o)}function Se(){if(!m||!r||!N)return;f=setTimeout(Se,U);let o={janus:"keepalive",session_id:D,transaction:e.randomString(12)};A&&(o.token=A),k&&(o.apisecret=k),i.send(JSON.stringify(o))}function Q(o){let c=e.randomString(12),u={janus:"create",transaction:c};if(o.reconnect&&(N=!1,u.janus="claim",u.session_id=D,i&&(i.onopen=null,i.onerror=null,i.onclose=null,f&&(clearTimeout(f),f=null))),A&&(u.token=A),k&&(u.apisecret=k),!m&&e.isArray(d)&&(m=d[S],m.indexOf("ws")===0?(r=!0,e.log("Server #"+(S+1)+": trying WebSockets to contact Janus ("+m+")")):(r=!1,e.log("Server #"+(S+1)+": trying REST API to contact Janus ("+m+")"))),r){i=e.newWebSocket(m,"janus-protocol"),a={error:function(){if(e.error("Error connecting to the Janus WebSockets server... "+m),e.isArray(d)&&!o.reconnect){if(S++,S===d.length){o.error("Error connecting to any of the provided Janus servers: Is the server down?");return}m=null,setTimeout(function(){Q(o)},200);return}o.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){F.set(c,function(s){if(e.debug(s),s.janus!=="success"){e.error("Ooops: "+s.error.code+" "+s.error.reason),o.error(s.error.reason);return}f=setTimeout(Se,U),N=!0,D=s.session_id?s.session_id:s.data.id,o.reconnect?e.log("Claimed session: "+D):e.log("Created session: "+D),e.sessions.set(D,$),o.success()}),i.send(JSON.stringify(u))},message:function(s){se(JSON.parse(s.data))},close:function(){!m||!N||(N=!1,t.error("Lost connection to the server (is it down?)"))}};for(let s in a)i.addEventListener(s,a[s]);return}e.httpAPICall(m,{verb:"POST",withCredentials:_,body:u,success:function(s){if(e.debug(s),s.janus!=="success"){e.error("Ooops: "+s.error.code+" "+s.error.reason),o.error(s.error.reason);return}N=!0,D=s.session_id?s.session_id:s.data.id,o.reconnect?e.log("Claimed session: "+D):e.log("Created session: "+D),e.sessions.set(D,$),oe(),o.success()},error:function(s,g){if(e.error(s+":",g),e.isArray(d)&&!o.reconnect){if(S++,S===d.length){o.error("Error connecting to any of the provided Janus servers: Is the server down?");return}m=null,setTimeout(function(){Q(o)},200);return}g===""?o.error(s+": Is the server down?"):g&&g.error?o.error(s+": "+g.error.message):o.error(s+": "+g)}})}function Pt(o){if(o=o||{},o.success=typeof o.success=="function"?o.success:e.noop,o.error=typeof o.error=="function"?o.error:e.noop,e.log("Getting info on Janus instance"),!N){e.warn("Is the server down? (connected=false)"),o.error("Is the server down? (connected=false)");return}let c=e.randomString(12),u={janus:"info",transaction:c};if(A&&(u.token=A),k&&(u.apisecret=k),r){F.set(c,function(s){e.log("Server info:"),e.debug(s),s.janus!=="server_info"&&e.error("Ooops: "+s.error.code+" "+s.error.reason),o.success(s)}),i.send(JSON.stringify(u));return}e.httpAPICall(m,{verb:"POST",withCredentials:_,body:u,success:function(s){e.log("Server info:"),e.debug(s),s.janus!=="server_info"&&e.error("Ooops: "+s.error.code+" "+s.error.reason),o.success(s)},error:function(s,g){e.error(s+":",g),g===""?o.error(s+": Is the server down?"):o.error(s+": "+g)}})}function bt(o){o=o||{},o.success=typeof o.success=="function"?o.success:e.noop,o.error=typeof o.error=="function"?o.error:e.noop;let c=o.unload===!0,u=!0;typeof o.notifyDestroyed<"u"&&o.notifyDestroyed!==null&&(u=o.notifyDestroyed===!0);let s=o.cleanupHandles===!0;if(e.log("Destroying session "+D+" (unload="+c+")"),!D){e.warn("No session to destroy"),o.success(),u&&t.destroyed();return}if(s)for(const h of M.keys())ce(h,{noRequest:!0});if(!N){e.warn("Is the server down? (connected=false)"),D=null,o.success();return}let g={janus:"destroy",transaction:e.randomString(12)};if(A&&(g.token=A),k&&(g.apisecret=k),c){r?(i.onclose=null,i.close(),i=null):navigator.sendBeacon(m+"/"+D,JSON.stringify(g)),e.log("Destroyed session:"),D=null,N=!1,o.success(),u&&t.destroyed();return}if(r){g.session_id=D;let h=function(){for(let C in a)i.removeEventListener(C,a[C]);i.removeEventListener("message",l),i.removeEventListener("error",R),f&&clearTimeout(f),i.close()},l=function(C){let p=JSON.parse(C.data);p.session_id==g.session_id&&p.transaction==g.transaction&&(h(),o.success(),u&&t.destroyed())},R=function(){h(),o.error("Failed to destroy the server: Is the server down?"),u&&t.destroyed()};i.addEventListener("message",l),i.addEventListener("error",R),i.readyState===1?i.send(JSON.stringify(g)):R();return}e.httpAPICall(m+"/"+D,{verb:"POST",withCredentials:_,body:g,success:function(h){e.log("Destroyed session:"),e.debug(h),D=null,N=!1,h.janus!=="success"&&e.error("Ooops: "+h.error.code+" "+h.error.reason),o.success(),u&&t.destroyed()},error:function(h,l){e.error(h+":",l),D=null,N=!1,o.success(),u&&t.destroyed()}})}function Et(o){if(o=o||{},o.success=typeof o.success=="function"?o.success:e.noop,o.error=typeof o.error=="function"?o.error:e.noop,o.dataChannelOptions=o.dataChannelOptions||{ordered:!0},o.consentDialog=typeof o.consentDialog=="function"?o.consentDialog:e.noop,o.connectionState=typeof o.connectionState=="function"?o.connectionState:e.noop,o.iceState=typeof o.iceState=="function"?o.iceState:e.noop,o.mediaState=typeof o.mediaState=="function"?o.mediaState:e.noop,o.webrtcState=typeof o.webrtcState=="function"?o.webrtcState:e.noop,o.slowLink=typeof o.slowLink=="function"?o.slowLink:e.noop,o.onmessage=typeof o.onmessage=="function"?o.onmessage:e.noop,o.onlocaltrack=typeof o.onlocaltrack=="function"?o.onlocaltrack:e.noop,o.onremotetrack=typeof o.onremotetrack=="function"?o.onremotetrack:e.noop,o.ondata=typeof o.ondata=="function"?o.ondata:e.noop,o.ondataopen=typeof o.ondataopen=="function"?o.ondataopen:e.noop,o.oncleanup=typeof o.oncleanup=="function"?o.oncleanup:e.noop,o.ondetached=typeof o.ondetached=="function"?o.ondetached:e.noop,!N){e.warn("Is the server down? (connected=false)"),o.error("Is the server down? (connected=false)");return}let c=o.plugin;if(!c){e.error("Invalid plugin"),o.error("Invalid plugin");return}let u=o.opaqueId,s=o.loopIndex,g=o.token?o.token:A,h=e.randomString(12),l={janus:"attach",plugin:c,opaque_id:u,loop_index:s,transaction:h};if(g&&(l.token=g),k&&(l.apisecret=k),r){F.set(h,function(R){if(e.debug(R),R.janus!=="success"){e.error("Ooops: "+R.error.code+" "+R.error.reason),o.error("Ooops: "+R.error.code+" "+R.error.reason);return}let C=R.data.id;e.log("Created handle: "+C);let p={session:$,plugin:c,id:C,token:g,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:o.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return C},getPlugin:function(){return c},getVolume:function(v,E){return H(C,v,!0,E)},getRemoteVolume:function(v,E){return H(C,v,!0,E)},getLocalVolume:function(v,E){return H(C,v,!1,E)},isAudioMuted:function(v){return X(C,v,!1)},muteAudio:function(v){return G(C,v,!1,!0)},unmuteAudio:function(v){return G(C,v,!1,!1)},isVideoMuted:function(v){return X(C,v,!0)},muteVideo:function(v){return G(C,v,!0,!0)},unmuteVideo:function(v){return G(C,v,!0,!1)},getBitrate:function(v){return Ie(C,v)},setMaxBitrate:function(v,E){return xe(C,v,E)},send:function(v){Ce(C,v)},data:function(v){Re(C,v)},dtmf:function(v){Pe(C,v)},consentDialog:o.consentDialog,connectionState:o.connectionState,iceState:o.iceState,mediaState:o.mediaState,webrtcState:o.webrtcState,slowLink:o.slowLink,onmessage:o.onmessage,createOffer:function(v){Y(C,!0,v)},createAnswer:function(v){Y(C,!1,v)},handleRemoteJsep:function(v){be(C,v)},replaceTracks:function(v){Ee(C,v)},getLocalTracks:function(){return _e(C)},getRemoteTracks:function(){return De(C)},onlocaltrack:o.onlocaltrack,onremotetrack:o.onremotetrack,ondata:o.ondata,ondataopen:o.ondataopen,oncleanup:o.oncleanup,ondetached:o.ondetached,hangup:function(v){ue(C,v===!0)},detach:function(v){ce(C,v)}};M.set(C,p),o.success(p)}),l.session_id=D,i.send(JSON.stringify(l));return}e.httpAPICall(m+"/"+D,{verb:"POST",withCredentials:_,body:l,success:function(R){if(e.debug(R),R.janus!=="success"){e.error("Ooops: "+R.error.code+" "+R.error.reason),o.error("Ooops: "+R.error.code+" "+R.error.reason);return}let C=R.data.id;e.log("Created handle: "+C);let p={session:$,plugin:c,id:C,token:g,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:o.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return C},getPlugin:function(){return c},getVolume:function(v,E){return H(C,v,!0,E)},getRemoteVolume:function(v,E){return H(C,v,!0,E)},getLocalVolume:function(v,E){return H(C,v,!1,E)},isAudioMuted:function(v){return X(C,v,!1)},muteAudio:function(v){return G(C,v,!1,!0)},unmuteAudio:function(v){return G(C,v,!1,!1)},isVideoMuted:function(v){return X(C,v,!0)},muteVideo:function(v){return G(C,v,!0,!0)},unmuteVideo:function(v){return G(C,v,!0,!1)},getBitrate:function(v){return Ie(C,v)},setMaxBitrate:function(v,E){return xe(C,v,E)},send:function(v){Ce(C,v)},data:function(v){Re(C,v)},dtmf:function(v){Pe(C,v)},consentDialog:o.consentDialog,connectionState:o.connectionState,iceState:o.iceState,mediaState:o.mediaState,webrtcState:o.webrtcState,slowLink:o.slowLink,onmessage:o.onmessage,createOffer:function(v){Y(C,!0,v)},createAnswer:function(v){Y(C,!1,v)},handleRemoteJsep:function(v){be(C,v)},replaceTracks:function(v){Ee(C,v)},getLocalTracks:function(){return _e(C)},getRemoteTracks:function(){return De(C)},onlocaltrack:o.onlocaltrack,onremotetrack:o.onremotetrack,ondata:o.ondata,ondataopen:o.ondataopen,oncleanup:o.oncleanup,ondetached:o.ondetached,hangup:function(v){ue(C,v===!0)},detach:function(v){ce(C,v)}};M.set(C,p),o.success(p)},error:function(R,C){e.error(R+":",C),C===""?o.error(R+": Is the server down?"):o.error(R+": "+C)}})}function Ce(o,c){if(c=c||{},c.success=typeof c.success=="function"?c.success:e.noop,c.error=typeof c.error=="function"?c.error:e.noop,!N){e.warn("Is the server down? (connected=false)"),c.error("Is the server down? (connected=false)");return}let u=M.get(o);if(!u||!u.webrtcStuff){e.warn("Invalid handle"),c.error("Invalid handle");return}let s=c.message,g=c.jsep,h=e.randomString(12),l={janus:"message",body:s,transaction:h};if(u.token&&(l.token=u.token),k&&(l.apisecret=k),g){l.jsep={type:g.type,sdp:g.sdp},g.e2ee&&(l.jsep.e2ee=!0),(g.rid_order==="hml"||g.rid_order==="lmh")&&(l.jsep.rid_order=g.rid_order),g.force_relay&&(l.jsep.force_relay=!0);let R=null,C=u.webrtcStuff;if(C.pc){let p=C.pc.getTransceivers();if(p&&p.length>0)for(let v in p){let E=p[v];if(E&&E.sender&&E.sender.track&&E.sender.track.kind==="video"){let x=E.sender.getParameters();x&&x.encodings&&x.encodings.length===1&&x.encodings[0]&&x.encodings[0].scalabilityMode&&(R||(R=[]),R.push({mindex:parseInt(v),mid:E.mid,svc:x.encodings[0].scalabilityMode}))}}}R&&(l.jsep.svc=R)}if(e.debug("Sending message to plugin (handle="+o+"):"),e.debug(l),r){l.session_id=D,l.handle_id=o,F.set(h,function(R){if(e.debug("Message sent!"),e.debug(R),R.janus==="success"){let C=R.plugindata;if(!C){e.warn("Request succeeded, but missing plugindata..."),c.success();return}e.log("Synchronous transaction successful ("+C.plugin+")");let p=C.data;e.debug(p),c.success(p);return}else if(R.janus!=="ack"){R.error?(e.error("Ooops: "+R.error.code+" "+R.error.reason),c.error(R.error.code+" "+R.error.reason)):(e.error("Unknown error"),c.error("Unknown error"));return}c.success()}),i.send(JSON.stringify(l));return}e.httpAPICall(m+"/"+D+"/"+o,{verb:"POST",withCredentials:_,body:l,success:function(R){if(e.debug("Message sent!"),e.debug(R),R.janus==="success"){let C=R.plugindata;if(!C){e.warn("Request succeeded, but missing plugindata..."),c.success();return}e.log("Synchronous transaction successful ("+C.plugin+")");let p=C.data;e.debug(p),c.success(p);return}else if(R.janus!=="ack"){R.error?(e.error("Ooops: "+R.error.code+" "+R.error.reason),c.error(R.error.code+" "+R.error.reason)):(e.error("Unknown error"),c.error("Unknown error"));return}c.success()},error:function(R,C){e.error(R+":",C),c.error(R+": "+C)}})}function Te(o,c){if(!N){e.warn("Is the server down? (connected=false)");return}let u=M.get(o);if(!u||!u.webrtcStuff){e.warn("Invalid handle");return}let s={janus:"trickle",candidate:c,transaction:e.randomString(12)};if(u.token&&(s.token=u.token),k&&(s.apisecret=k),e.vdebug("Sending trickle candidate (handle="+o+"):"),e.vdebug(s),r){s.session_id=D,s.handle_id=o,i.send(JSON.stringify(s));return}e.httpAPICall(m+"/"+D+"/"+o,{verb:"POST",withCredentials:_,body:s,success:function(g){if(e.vdebug("Candidate sent!"),e.vdebug(g),g.janus!=="ack"){e.error("Ooops: "+g.error.code+" "+g.error.reason);return}},error:function(g,h){e.error(g+":",h)}})}function ae(o,c,u,s,g){let h=M.get(o);if(!h||!h.webrtcStuff){e.warn("Invalid handle");return}let l=h.webrtcStuff;if(!l.pc){e.warn("Invalid PeerConnection");return}let R=function(v){e.log("Received message on data channel:",v);let E=v.target.label;h.ondata(v.data,E)},C=function(v){e.log("Received state change on data channel:",v);let E=v.target.label,x=v.target.protocol,L=l.dataChannel[E]?l.dataChannel[E].readyState:"null";if(e.log("State change on <"+E+"> data channel: "+L),L==="open"){if(l.dataChannel[E].pending&&l.dataChannel[E].pending.length>0){e.log("Sending pending messages on <"+E+">:",l.dataChannel[E].pending.length);for(let z of l.dataChannel[E].pending)e.log("Sending data on data channel <"+E+">"),e.debug(z),l.dataChannel[E].send(z);l.dataChannel[E].pending=[]}h.ondataopen(E,x)}},p=function(v){e.error("Got error on data channel:",v)};if(s)l.dataChannel[c]=s;else{let v=l.dataChannelOptions;u&&(v.protocol=u),l.dataChannel[c]=l.pc.createDataChannel(c,v)}l.dataChannel[c].onmessage=R,l.dataChannel[c].onopen=C,l.dataChannel[c].onclose=C,l.dataChannel[c].onerror=p,l.dataChannel[c].pending=[],g&&l.dataChannel[c].pending.push(g)}function Re(o,c){c=c||{},c.success=typeof c.success=="function"?c.success:e.noop,c.error=typeof c.error=="function"?c.error:e.noop;let u=M.get(o);if(!u||!u.webrtcStuff){e.warn("Invalid handle"),c.error("Invalid handle");return}let s=u.webrtcStuff,g=c.text||c.data;if(!g){e.warn("Invalid data"),c.error("Invalid data");return}let h=c.label?c.label:e.dataChanDefaultLabel;if(!s.dataChannel[h]){ae(o,h,c.protocol,!1,g,c.protocol),c.success();return}if(s.dataChannel[h].readyState!=="open"){s.dataChannel[h].pending.push(g),c.success();return}e.log("Sending data on data channel <"+h+">"),e.debug(g),s.dataChannel[h].send(g),c.success()}function Pe(o,c){c=c||{},c.success=typeof c.success=="function"?c.success:e.noop,c.error=typeof c.error=="function"?c.error:e.noop;let u=M.get(o);if(!u||!u.webrtcStuff){e.warn("Invalid handle"),c.error("Invalid handle");return}let s=u.webrtcStuff;if(!s.dtmfSender){if(s.pc){let p=s.pc.getSenders().find(function(v){return v.track&&v.track.kind==="audio"});if(!p){e.warn("Invalid DTMF configuration (no audio track)"),c.error("Invalid DTMF configuration (no audio track)");return}s.dtmfSender=p.dtmf,s.dtmfSender&&(e.log("Created DTMF Sender"),s.dtmfSender.ontonechange=function(v){e.debug("Sent DTMF tone: "+v.tone)})}if(!s.dtmfSender){e.warn("Invalid DTMF configuration"),c.error("Invalid DTMF configuration");return}}let g=c.dtmf;if(!g){e.warn("Invalid DTMF parameters"),c.error("Invalid DTMF parameters");return}let h=g.tones;if(!h){e.warn("Invalid DTMF string"),c.error("Invalid DTMF string");return}let l=typeof g.duration=="number"?g.duration:500,R=typeof g.gap=="number"?g.gap:50;e.debug("Sending DTMF string "+h+" (duration "+l+"ms, gap "+R+"ms)"),s.dtmfSender.insertDTMF(h,l,R),c.success()}function ce(o,c){c=c||{},c.success=typeof c.success=="function"?c.success:e.noop,c.error=typeof c.error=="function"?c.error:e.noop;let u=c.noRequest===!0;e.log("Destroying handle "+o+" (only-locally="+u+")"),ue(o);let s=M.get(o);if(!s||s.detached){M.delete(o),c.success();return}if(s.detached=!0,u){M.delete(o),c.success();return}if(!N){e.warn("Is the server down? (connected=false)"),c.error("Is the server down? (connected=false)");return}let g={janus:"detach",transaction:e.randomString(12)};if(s.token&&(g.token=s.token),k&&(g.apisecret=k),r){g.session_id=D,g.handle_id=o,i.send(JSON.stringify(g)),M.delete(o),c.success();return}e.httpAPICall(m+"/"+D+"/"+o,{verb:"POST",withCredentials:_,body:g,success:function(h){e.log("Destroyed handle:"),e.debug(h),h.janus!=="success"&&e.error("Ooops: "+h.error.code+" "+h.error.reason),M.delete(o),c.success()},error:function(h,l){e.error(h+":",l),M.delete(o),c.success()}})}function _t(o,c){let u=M.get(o);if(!u||!u.webrtcStuff)throw e.warn("Invalid handle"),"Invalid handle";let s=u.webrtcStuff;if(s.pc)return;let g={iceServers:y,iceTransportPolicy:b,bundlePolicy:P};g.sdpSemantics="unified-plan";let h=!1;if(c.tracks){for(let l of c.tracks)if(l.transforms&&(l.transforms.sender||l.transforms.receiver)){h=!0;break}}c.externalEncryption&&(h=!0,s.externalEncryption=!0),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&h&&(s.insertableStreams=!0,g.forceEncodedAudioInsertableStreams=!0,g.forceEncodedVideoInsertableStreams=!0,g.encodedInsertableStreams=!0),e.log("Creating PeerConnection"),s.pc=new RTCPeerConnection(g),e.debug(s.pc),s.pc.getStats&&(s.volume={},s.bitrate.value="0 kbits/sec"),e.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.onconnectionstatechange=function(){s.pc&&u.connectionState(s.pc.connectionState)},s.pc.oniceconnectionstatechange=function(){s.pc&&u.iceState(s.pc.iceConnectionState)},s.pc.onicecandidate=function(l){if(!l.candidate||l.candidate.candidate&&l.candidate.candidate.indexOf("endOfCandidates")>0)e.log("End of candidates."),s.iceDone=!0,s.trickle===!0?Te(o,{completed:!0}):xt(o,c);else{let R={candidate:l.candidate.candidate,sdpMid:l.candidate.sdpMid,sdpMLineIndex:l.candidate.sdpMLineIndex};s.trickle===!0&&Te(o,R)}},s.pc.ontrack=function(l){if(e.log("Handling Remote Track",l),!l.streams||!l.track)return;let R=l.transceiver?l.transceiver.mid:l.track.id;try{l.transceiver&&l.transceiver.mid&&l.track.id&&(u.mids||(u.mids={}),u.mids[l.track.id]=l.transceiver.mid),u.onremotetrack(l.track,R,!0,{reason:"created"})}catch(p){e.error("Error calling onremotetrack",p)}if(l.track.onended)return;let C=null;e.log("Adding onended callback to track:",l.track),l.track.onended=function(p){e.log("Remote track removed:",p),clearTimeout(C);let v=s.pc?s.pc.getTransceivers():null,E=v?v.find(L=>L.receiver.track===p.target):null,x=E?E.mid:p.target.id;x===p.target.id&&u.mids&&u.mids[l.track.id]&&(x=u.mids[l.track.id]);try{u.onremotetrack(p.target,x,!1,{reason:"ended"})}catch(L){e.error("Error calling onremotetrack on removal",L)}delete u.mids[l.track.id]},l.track.onmute=function(p){e.log("Remote track muted:",p),C||(C=setTimeout(function(){e.log("Removing remote track");let v=s.pc?s.pc.getTransceivers():null,E=v?v.find(L=>L.receiver.track===p.target):null,x=E?E.mid:p.target.id;x===p.target.id&&u.mids&&u.mids[l.track.id]&&(x=u.mids[l.track.id]);try{u.onremotetrack(p.target,x,!1,{reason:"mute"})}catch(L){e.error("Error calling onremotetrack on mute",L)}C=null},3*840))},l.track.onunmute=function(p){if(e.log("Remote track flowing again:",p),C!=null)clearTimeout(C),C=null;else try{let v=s.pc?s.pc.getTransceivers():null,E=v?v.find(L=>L.receiver.track===p.target):null,x=E?E.mid:p.target.id;u.onremotetrack(p.target,x,!0,{reason:"unmute"})}catch(v){e.error("Error calling onremotetrack on unmute",v)}}}}async function Y(o,c,u){u=u||{},u.success=typeof u.success=="function"?u.success:e.noop,u.error=typeof u.error=="function"?u.error:Me;let s=u.jsep;if(c&&s){e.error("Provided a JSEP to a createOffer"),u.error("Provided a JSEP to a createOffer");return}else if(!c&&(!s||!s.type||!s.sdp)){e.error("A valid JSEP is required for createAnswer"),u.error("A valid JSEP is required for createAnswer");return}if(u.media&&!u.tracks){if(u.tracks=e.mediaToTracks(u.media),u.simulcast===!0||u.simulcast2===!0||u.svc){for(let l of u.tracks)if(l.type==="video"){u.simulcast===!0||u.simulcast2===!0?l.simulcast=!0:u.svc&&(l.svc=u.svc);break}}e.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",u.tracks)}if(u.tracks&&!Array.isArray(u.tracks)){e.error("Tracks must be an array"),u.error("Tracks must be an array");return}let g=M.get(o);if(!g||!g.webrtcStuff){e.warn("Invalid handle"),u.error("Invalid handle");return}let h=g.webrtcStuff;h.trickle=Mt(u.trickle);try{if(_t(o,u),c&&await de(o,u),s){if(await h.pc.setRemoteDescription(s),e.log("Remote description accepted!"),h.remoteSdp=s.sdp,h.candidates&&h.candidates.length>0){for(let R=0;R<h.candidates.length;R++){let C=h.candidates[R];e.debug("Adding remote candidate:",C),!C||C.completed===!0?h.pc.addIceCandidate(e.endOfCandidates):h.pc.addIceCandidate(C)}h.candidates=[]}await de(o,u);let l=await It(o,u);u.success(l)}else{let l=await Dt(o,u);u.success(l)}}catch(l){e.error(l),u.error(l)}}function be(o,c){c=c||{},c.success=typeof c.success=="function"?c.success:e.noop,c.error=typeof c.error=="function"?c.error:Me,c.customizeSdp=typeof c.customizeSdp=="function"?c.customizeSdp:e.noop;let u=c.jsep,s=M.get(o);if(!s||!s.webrtcStuff){e.warn("Invalid handle"),c.error("Invalid handle");return}let g=s.webrtcStuff;if(u){if(!g.pc){e.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),c.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");return}c.customizeSdp(u),g.pc.setRemoteDescription(u).then(function(){if(e.log("Remote description accepted!"),g.remoteSdp=u.sdp,g.candidates&&g.candidates.length>0){for(let h=0;h<g.candidates.length;h++){let l=g.candidates[h];e.debug("Adding remote candidate:",l),!l||l.completed===!0?g.pc.addIceCandidate(e.endOfCandidates):g.pc.addIceCandidate(l)}g.candidates=[]}c.success()},c.error)}else c.error("Invalid JSEP")}async function Dt(o,c){c=c||{},c.customizeSdp=typeof c.customizeSdp=="function"?c.customizeSdp:e.noop;let u=M.get(o);if(!u||!u.webrtcStuff)throw e.warn("Invalid handle"),"Invalid handle";let s=u.webrtcStuff;e.log("Creating offer (iceDone="+s.iceDone+")");let g={};c.iceRestart===!0&&(g.iceRestart=!0),e.debug(g);let l=await s.pc.createOffer(g);e.debug(l);let R={type:"offer",sdp:l.sdp};return c.customizeSdp(R),l.sdp=R.sdp,e.log("Setting local description"),s.mySdp={type:"offer",sdp:l.sdp},await s.pc.setLocalDescription(l),s.mediaConstraints=g,!s.iceDone&&!s.trickle?(e.log("Waiting for all candidates..."),null):((s.insertableStreams||s.externalEncryption)&&(l.e2ee=!0),l)}async function It(o,c){c=c||{},c.customizeSdp=typeof c.customizeSdp=="function"?c.customizeSdp:e.noop;let u=M.get(o);if(!u||!u.webrtcStuff)throw e.warn("Invalid handle"),"Invalid handle";let s=u.webrtcStuff;e.log("Creating answer (iceDone="+s.iceDone+")");let g=await s.pc.createAnswer();e.debug(g);let h={type:"answer",sdp:g.sdp};return c.customizeSdp(h),g.sdp=h.sdp,e.log("Setting local description"),s.mySdp={type:"answer",sdp:g.sdp},await s.pc.setLocalDescription(g),!s.iceDone&&!s.trickle?(e.log("Waiting for all candidates..."),null):((s.insertableStreams||s.externalEncryption)&&(g.e2ee=!0),g)}function xt(o,c){c=c||{},c.success=typeof c.success=="function"?c.success:e.noop,c.error=typeof c.error=="function"?c.error:e.noop;let u=M.get(o);if(!u||!u.webrtcStuff){e.warn("Invalid handle, not sending anything");return}let s=u.webrtcStuff;if(e.log("Sending offer/answer SDP..."),!s.mySdp){e.warn("Local SDP instance is invalid, not sending anything...");return}s.mySdp={type:s.pc.localDescription.type,sdp:s.pc.localDescription.sdp},s.trickle===!1&&(s.mySdp.trickle=!1),e.debug(c),s.sdpSent=!0,c.success(s.mySdp)}async function Ee(o,c){if(c=c||{},c.success=typeof c.success=="function"?c.success:e.noop,c.error=typeof c.error=="function"?c.error:e.noop,c.tracks&&!Array.isArray(c.tracks)){e.error("Tracks must be an array"),c.error("Tracks must be an array");return}for(let u of c.tracks)(u.add||!u.replace&&!u.remove)&&(u.replace=!0);try{await de(o,c),c.success()}catch(u){e.error(u),c.error(u)}}async function de(o,c){let u=M.get(o);if(!u||!u.webrtcStuff)throw e.warn("Invalid handle, not sending anything"),"Invalid handle";let s=u.webrtcStuff;if(!s.pc)throw e.warn("Invalid PeerConnection"),"Invalid PeerConnection";let g=c.tracks;if(!g||!Array.isArray(g)||g.length===0)return;let h=!1,l={};for(let p of g){if(delete p.gumGroup,!p.type||!["audio","video"].includes(p.type)||!p.capture||p.capture instanceof MediaStreamTrack)continue;let v=p.group?p.group:"default";l[v]||(l[v]={}),!l[v][p.type]&&(p.gumGroup=v,l[v][p.type]=p)}let R=Object.keys(l);for(let p of R){let v=l[p];(!v.audio||!v.video)&&(v.audio&&delete v.audio.gumGroup,v.video&&delete v.video.gumGroup,delete l[p])}let C=!!c.jsep;for(let p of g){if(!p.type){e.warn("Missing track type:",p);continue}if(p.type==="data"){if(s.pc.ondatachannel){e.warn("Data channel exists already, not creating another one");continue}e.log("Creating default data channel"),ae(o,e.dataChanDefaultLabel,null,!1),s.pc.ondatachannel=function(T){e.log("Data channel created by Janus:",T),ae(o,T.channel.label,T.channel.protocol,T.channel)};continue}if((typeof p.add>"u"||p.add===null)&&(typeof p.remove>"u"||p.remove===null)&&(typeof p.replace>"u"||p.replace===null)&&(p.add=!0),p.add&&p.remove||p.add&&p.remove&&p.replace){e.warn("Conflicting actions for track, ignoring:",p);continue}p.add&&p.replace?(e.warn("Both add and replace provided, falling back to replace:",p),delete p.add):p.remove&&p.replace&&(e.warn("Both remove and replace provided, falling back to remove:",p),delete p.replace);let v=p.type;p.type==="screen"&&(v="video");let E=null,x=null;if(p.mid?E=s.pc.getTransceivers().find(T=>T.mid===p.mid&&T.receiver.track.kind===v):p.add||(E=s.pc.getTransceivers().find(T=>T.receiver.track.kind===v)),p.replace||p.remove){if(!E){e.warn("Couldn't find a transceiver for track:",p);continue}if(!E.sender){e.warn("No sender in the transceiver for track:",p);continue}x=E.sender}if(C&&!E&&(E=s.pc.getTransceivers().find(T=>T.receiver.track.kind===v),!E)){e.warn("Couldn't find a transceiver for track:",p);continue}let L=null,z=null;if((p.remove||p.replace)&&(e.log("Removing track from PeerConnection",p),z=x.track?x.track.id:null,await x.replaceTrack(null),z&&s.myStream)){let T=null;if(v==="audio"&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length)for(let O of s.myStream.getAudioTracks())O.id===z&&(T=O,e.log("Removing audio track:",T));else if(v==="video"&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length)for(let O of s.myStream.getVideoTracks())O.id===z&&(T=O,e.log("Removing video track:",T));if(T){try{s.myStream.removeTrack(T),u.onlocaltrack(T,!1)}catch(O){e.error("Error calling onlocaltrack on removal for renegotiation",O)}if(T.dontStop!==!0)try{T.stop()}catch{}}}if(p.capture){if(p.gumGroup&&l[p.gumGroup]&&l[p.gumGroup].stream){let T=l[p.gumGroup].stream;L=p.type==="audio"?T.getAudioTracks()[0]:T.getVideoTracks()[0],delete l[p.gumGroup].stream,delete l[p.gumGroup],delete p.gumGroup}else if(p.capture instanceof MediaStreamTrack)L=p.capture;else{h||(h=!0,u.consentDialog(!0));let T=e.trackConstraints(p),O=null;if(p.type==="audio"||p.type==="video"){if(p.gumGroup){let j=p.type==="audio"?"video":"audio";if(l[p.gumGroup]&&l[p.gumGroup][j]){let q=l[p.gumGroup][j],Ot=e.trackConstraints(q);T[j]=Ot[j]}}O=await navigator.mediaDevices.getUserMedia(T),p.gumGroup&&T.audio&&T.video&&(l[p.gumGroup].stream=O,delete p.gumGroup)}else O=await navigator.mediaDevices.getDisplayMedia(T);L=p.type==="audio"?O.getAudioTracks()[0]:O.getVideoTracks()[0]}if(p.replace){await x.replaceTrack(L);let T="sendrecv";(p.recv===!1||E.direction==="inactive"||E.direction==="sendonly")&&(T="sendonly"),E.setDirection?E.setDirection(T):E.direction=T}else{if(s.myStream||(s.myStream=new MediaStream),v==="audio"||!p.simulcast&&!p.svc)x=s.pc.addTrack(L,s.myStream),E=s.pc.getTransceivers().find(T=>T.sender===x);else if(p.simulcast){e.log("Enabling rid-based simulcasting:",L);let T=Rt(p.simulcastMaxBitrates);E=s.pc.addTransceiver(L,{direction:"sendrecv",streams:[s.myStream],sendEncodings:p.sendEncodings||[{rid:"h",active:!0,scalabilityMode:"L1T2",maxBitrate:T.high},{rid:"m",active:!0,scalabilityMode:"L1T2",maxBitrate:T.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,scalabilityMode:"L1T2",maxBitrate:T.low,scaleResolutionDownBy:4}]})}else e.log("Enabling SVC ("+p.svc+"):",L),E=s.pc.addTransceiver(L,{direction:"sendrecv",streams:[s.myStream],sendEncodings:[{scalabilityMode:p.svc}]});if(x||(x=E?E.sender:null),p.codec)if(e.webRTCAdapter.browserDetails.browser==="firefox")e.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",p);else if(typeof p.codec!="string")e.warn("Invalid codec value, ignoring for track:",p);else{let T=v+"/"+p.codec.toLowerCase(),O=RTCRtpReceiver.getCapabilities(v).codecs.filter(function(j){return j.mimeType.toLowerCase()===T});if(!O||O.length===0)e.warn("Codec not supported in this browser for this track, ignoring:",p);else if(E)try{E.setCodecPreferences(O)}catch(j){e.warn("Failed enforcing codec for this "+v+" track:",j)}}if(p.bitrate){if(p.simulcast||p.svc)e.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(p.bitrate)||p.bitrate<0)e.warn("Ignoring invalid bitrate for track:",p);else if(x){let T=x.getParameters();!T||!T.encodings||T.encodings.length===0?e.warn("No encodings in the sender parameters, ignoring bitrate for track:",p):(T.encodings[0].maxBitrate=p.bitrate,await x.setParameters(T))}}if(v==="video"&&p.framerate){if(p.simulcast||p.svc)e.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(p.framerate)||p.framerate<0)e.warn("Ignoring invalid framerate for track:",p);else if(x){let T=x.getParameters();!T||!T.encodings||T.encodings.length===0?e.warn("No encodings in the sender parameters, ignoring framerate for track:",p):(T.encodings[0].maxFramerate=p.framerate,await x.setParameters(T))}}if(p.transforms){if(x&&p.transforms.sender){let T=null;RTCRtpSender.prototype.createEncodedStreams?T=x.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&(v==="audio"?T=x.createEncodedAudioStreams():v==="video"&&(T=x.createEncodedVideoStreams())),T&&(T.readableStream&&T.writableStream?T.readableStream.pipeThrough(p.transforms.sender).pipeTo(T.writableStream):T.readable&&T.writable&&T.readable.pipeThrough(p.transforms.sender).pipeTo(T.writable))}if(E&&E.receiver&&p.transforms.receiver){let T=null;RTCRtpReceiver.prototype.createEncodedStreams?T=E.receiver.createEncodedStreams():(RTCRtpReceiver.prototype.createAudioEncodedStreams||RTCRtpReceiver.prototype.createEncodedVideoStreams)&&(v==="audio"?T=E.receiver.createEncodedAudioStreams():v==="video"&&(T=E.receiver.createEncodedVideoStreams())),T&&(T.readableStream&&T.writableStream?T.readableStream.pipeThrough(p.transforms.receiver).pipeTo(T.writableStream):T.readable&&T.writable&&T.readable.pipeThrough(p.transforms.receiver).pipeTo(T.writable))}}}L&&p.dontStop===!0&&(L.dontStop=!0)}else if(p.recv&&(E||(E=s.pc.addTransceiver(v)),E)){if(p.codec)if(e.webRTCAdapter.browserDetails.browser==="firefox")e.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",p);else if(typeof p.codec!="string")e.warn("Invalid codec value, ignoring for track:",p);else{let T=v+"/"+p.codec.toLowerCase(),O=RTCRtpReceiver.getCapabilities(v).codecs.filter(function(j){return j.mimeType.toLowerCase()===T});if(!O||O.length===0)e.warn("Codec not supported in this browser for this track, ignoring:",p);else try{E.setCodecPreferences(O)}catch(j){e.warn("Failed enforcing codec for this "+v+" track:",j)}}if(E.receiver&&p.transforms&&p.transforms.receiver){let T=null;RTCRtpReceiver.prototype.createEncodedStreams?T=E.receiver.createEncodedStreams():(RTCRtpReceiver.prototype.createAudioEncodedStreams||RTCRtpReceiver.prototype.createEncodedVideoStreams)&&(v==="audio"?T=E.receiver.createEncodedAudioStreams():v==="video"&&(T=E.receiver.createEncodedVideoStreams())),T&&(T.readableStream&&T.writableStream?T.readableStream.pipeThrough(p.transforms.receiver).pipeTo(T.writableStream):T.readable&&T.writable&&T.readable.pipeThrough(p.transforms.receiver).pipeTo(T.writable))}}if(L){s.myStream.addTrack(L),L.onended=function(T){e.log("Local track removed:",T);try{u.onlocaltrack(T.target,!1)}catch(O){e.error("Error calling onlocaltrack following end",O)}};try{u.onlocaltrack(L,!0)}catch(T){e.error("Error calling onlocaltrack for track add",T)}}if(E){let T=E.direction,O=null,j=L&&E.sender.track,q=p.recv!==!1&&E.receiver.track;j&&q?O="sendrecv":j&&!q?O="sendonly":!j&&q?O="recvonly":!j&&!q&&(O="inactive"),O&&O!==T&&(e.warn("Changing direction of transceiver to "+O+" (was "+T+")",p),E.setDirection?E.setDirection(O):E.direction=O)}}h&&u.consentDialog(!1)}function _e(o){let c=M.get(o);if(!c||!c.webrtcStuff)return e.warn("Invalid handle"),null;let u=c.webrtcStuff;if(!u.pc)return e.warn("Invalid PeerConnection"),null;let s=[],g=u.pc.getTransceivers();for(let h of g){let l=null;h.sender&&h.sender.track&&(l={mid:h.mid},l.type=h.sender.track.kind,l.id=h.sender.track.id,l.label=h.sender.track.label),l&&s.push(l)}return s}function De(o){let c=M.get(o);if(!c||!c.webrtcStuff)return e.warn("Invalid handle"),null;let u=c.webrtcStuff;if(!u.pc)return e.warn("Invalid PeerConnection"),null;let s=[],g=u.pc.getTransceivers();for(let h of g){let l=null;h.receiver&&h.receiver.track&&(l={mid:h.mid},l.type=h.receiver.track.kind,l.id=h.receiver.track.id,l.label=h.receiver.track.label),l&&s.push(l)}return s}function H(o,c,u,s){s=typeof s=="function"?s:e.noop;let g=M.get(o);if(!g||!g.webrtcStuff){e.warn("Invalid handle"),s(0);return}let h=u?"remote":"local",l=g.webrtcStuff;if(l.volume[h]||(l.volume[h]={value:0}),l.pc&&l.pc.getStats&&(e.webRTCAdapter.browserDetails.browser==="chrome"||e.webRTCAdapter.browserDetails.browser==="safari")){let R=l.pc;if(c){let C=l.pc.getTransceivers().find(p=>p.mid===c&&p.receiver.track.kind==="audio");if(!C){e.warn("No audio transceiver with mid "+c),s(0);return}if(u&&!C.receiver){e.warn("Remote transceiver track unavailable"),s(0);return}else if(!u&&!C.sender){e.warn("Local transceiver track unavailable"),s(0);return}R=u?C.receiver:C.sender}return R.getStats().then(function(C){C.forEach(function(p){!p||p.kind!=="audio"||u&&!p.remoteSource||!u&&p.type!=="media-source"||s(p.audioLevel?p.audioLevel:0)})}),l.volume[h].value}else{e.warn("Getting the "+h+" volume unsupported by browser"),s(0);return}}function X(o,c,u){let s=M.get(o);if(!s||!s.webrtcStuff)return e.warn("Invalid handle"),!0;let g=s.webrtcStuff;if(!g.pc)return e.warn("Invalid PeerConnection"),!0;if(!g.myStream)return e.warn("Invalid local MediaStream"),!0;if(u){if(!g.myStream.getVideoTracks()||g.myStream.getVideoTracks().length===0)return e.warn("No video track"),!0;if(c){let h=g.pc.getTransceivers().find(l=>l.mid===c&&l.receiver.track.kind==="video");return h?!h.sender||!h.sender.track?(e.warn("No video sender with mid "+c),!0):!h.sender.track.enabled:(e.warn("No video transceiver with mid "+c),!0)}else return!g.myStream.getVideoTracks()[0].enabled}else{if(!g.myStream.getAudioTracks()||g.myStream.getAudioTracks().length===0)return e.warn("No audio track"),!0;if(c){let h=g.pc.getTransceivers().find(l=>l.mid===c&&l.receiver.track.kind==="audio");return h?!h.sender||!h.sender.track?(e.warn("No audio sender with mid "+c),!0):!h.sender.track.enabled:(e.warn("No audio transceiver with mid "+c),!0)}else return!g.myStream.getAudioTracks()[0].enabled}}function G(o,c,u,s){let g=M.get(o);if(!g||!g.webrtcStuff)return e.warn("Invalid handle"),!1;let h=g.webrtcStuff;if(!h.pc)return e.warn("Invalid PeerConnection"),!1;if(!h.myStream)return e.warn("Invalid local MediaStream"),!1;if(u){if(!h.myStream.getVideoTracks()||h.myStream.getVideoTracks().length===0)return e.warn("No video track"),!1;if(c){let l=h.pc.getTransceivers().find(R=>R.mid===c&&R.receiver.track.kind==="video");if(!l)return e.warn("No video transceiver with mid "+c),!1;if(!l.sender||!l.sender.track)return e.warn("No video sender with mid "+c),!1;l.sender.track.enabled=!s}else for(const l of h.myStream.getVideoTracks())l.enabled=!s}else{if(!h.myStream.getAudioTracks()||h.myStream.getAudioTracks().length===0)return e.warn("No audio track"),!1;if(c){let l=h.pc.getTransceivers().find(R=>R.mid===c&&R.receiver.track.kind==="audio");if(!l)return e.warn("No audio transceiver with mid "+c),!1;if(!l.sender||!l.sender.track)return e.warn("No audio sender with mid "+c),!1;l.sender.track.enabled=!s}else for(const l of h.myStream.getAudioTracks())l.enabled=!s}return!0}function Ie(o,c){let u=M.get(o);if(!u||!u.webrtcStuff)return e.warn("Invalid handle"),"Invalid handle";let s=u.webrtcStuff;if(!s.pc)return"Invalid PeerConnection";if(s.pc.getStats){let g=s.pc,h=c||"default";if(c){let l=s.pc.getTransceivers().find(R=>R.mid===c&&R.receiver.track.kind==="video");if(!l)return e.warn("No video transceiver with mid "+c),"No video transceiver with mid "+c;if(!l.receiver)return e.warn("No video receiver with mid "+c),"No video receiver with mid "+c;g=l.receiver}return s.bitrate[h]||(s.bitrate[h]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),s.bitrate[h].timer?s.bitrate[h].value:(e.log("Starting bitrate timer"+(c?" for mid "+c:"")+" (via getStats)"),s.bitrate[h].timer=setInterval(function(){g.getStats().then(function(l){l.forEach(function(R){if(!R)return;let C=!1;if(((R.mediaType==="video"||R.kind==="video"||R.id.toLowerCase().indexOf("video")>-1)&&R.type==="inbound-rtp"&&R.id.indexOf("rtcp")<0||R.type=="ssrc"&&R.bytesReceived&&(R.googCodecName==="VP8"||R.googCodecName===""))&&(C=!0),C)if(s.bitrate[h].bsnow=R.bytesReceived,s.bitrate[h].tsnow=R.timestamp,s.bitrate[h].bsbefore===null||s.bitrate[h].tsbefore===null)s.bitrate[h].bsbefore=s.bitrate[h].bsnow,s.bitrate[h].tsbefore=s.bitrate[h].tsnow;else{let p=s.bitrate[h].tsnow-s.bitrate[h].tsbefore;e.webRTCAdapter.browserDetails.browser==="safari"&&(p=p/1e3);let v=Math.round((s.bitrate[h].bsnow-s.bitrate[h].bsbefore)*8/p);e.webRTCAdapter.browserDetails.browser==="safari"&&(v=parseInt(v/1e3)),s.bitrate[h].value=v+" kbits/sec",s.bitrate[h].bsbefore=s.bitrate[h].bsnow,s.bitrate[h].tsbefore=s.bitrate[h].tsnow}})})},1e3),"0 kbits/sec")}else return e.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function xe(o,c,u){let s=M.get(o);if(!s||!s.webrtcStuff){e.warn("Invalid handle");return}let g=s.webrtcStuff;if(!g.pc){e.warn("Invalid PeerConnection");return}let h=g.pc.getTransceivers().find(R=>R.mid===c);if(!h){e.warn("No transceiver with mid",c);return}if(!h.sender){e.warn("No sender for transceiver with mid",c);return}let l=h.sender.getParameters();!l||!l.encodings||l.encodings.length===0?e.warn("No parameters encodings"):l.encodings.length>1?e.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(u)||u<0?e.warn("Invalid bitrate (must be a positive integer)"):(l.encodings[0].maxBitrate=u,h.sender.setParameters(l))}function Me(o){e.error("WebRTC error:",o)}function ue(o,c){e.log("Cleaning WebRTC stuff");let u=M.get(o);if(!u)return;let s=u.webrtcStuff;if(s){if(c===!0){let g={janus:"hangup",transaction:e.randomString(12)};u.token&&(g.token=u.token),k&&(g.apisecret=k),e.debug("Sending hangup request (handle="+o+"):"),e.debug(g),r?(g.session_id=D,g.handle_id=o,i.send(JSON.stringify(g))):e.httpAPICall(m+"/"+D+"/"+o,{verb:"POST",withCredentials:_,body:g})}s.volume&&(s.volume.local&&s.volume.local.timer&&clearInterval(s.volume.local.timer),s.volume.remote&&s.volume.remote.timer&&clearInterval(s.volume.remote.timer));for(let g in s.bitrate)s.bitrate[g].timer&&clearInterval(s.bitrate[g].timer);s.bitrate={},!s.streamExternal&&s.myStream&&(e.log("Stopping local stream tracks"),e.stopAllTracks(s.myStream)),s.streamExternal=!1,s.myStream=null;try{s.pc.close()}catch{}s.pc=null,s.candidates=null,s.mySdp=null,s.remoteSdp=null,s.iceDone=!1,s.dataChannel={},s.dtmfSender=null,s.insertableStreams=!1,s.externalEncryption=!1}u.oncleanup()}function Mt(o){return e.debug("isTrickleEnabled:",o),o!==!1}}return e});let qe=!0,We=!0;function K(n,e,t){const r=n.match(e);return r&&r.length>=t&&parseFloat(r[t],10)}function J(n,e,t){if(!n.RTCPeerConnection)return;const r=n.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(f,d){if(f!==e)return i.apply(this,arguments);const S=m=>{const y=t(m);y&&(d.handleEvent?d.handleEvent(y):d(y))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(d,S),i.apply(this,[f,S])};const a=r.removeEventListener;r.removeEventListener=function(f,d){if(f!==e||!this._eventMap||!this._eventMap[e])return a.apply(this,arguments);if(!this._eventMap[e].has(d))return a.apply(this,arguments);const S=this._eventMap[e].get(d);return this._eventMap[e].delete(d),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,a.apply(this,[f,S])},Object.defineProperty(r,"on"+e,{get(){return this["_on"+e]},set(f){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),f&&this.addEventListener(e,this["_on"+e]=f)},enumerable:!0,configurable:!0})}function Bt(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(qe=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function Kt(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(We=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function Be(){if(typeof window=="object"){if(qe)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function ye(n,e){We&&console.warn(n+" is deprecated, please use "+e+" instead.")}function $t(n){const e={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=n;if(t.userAgentData&&t.userAgentData.brands){const r=t.userAgentData.brands.find(i=>i.brand==="Chromium");if(r)return{browser:"chrome",version:parseInt(r.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=parseInt(K(t.userAgent,/Firefox\/(\d+)\./,1));else if(t.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)e.browser="chrome",e.version=parseInt(K(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(n.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=parseInt(K(t.userAgent,/AppleWebKit\/(\d+)\./,1)),e.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype,e._safariVersion=K(t.userAgent,/Version\/(\d+(\.?\d+))/,1);else return e.browser="Not a supported browser.",e;return e}function Ve(n){return Object.prototype.toString.call(n)==="[object Object]"}function Ke(n){return Ve(n)?Object.keys(n).reduce(function(e,t){const r=Ve(n[t]),i=r?Ke(n[t]):n[t],a=r&&!Object.keys(i).length;return i===void 0||a?e:Object.assign(e,{[t]:i})},{}):n}function pe(n,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(r=>{r.endsWith("Id")?pe(n,n.get(e[r]),t):r.endsWith("Ids")&&e[r].forEach(i=>{pe(n,n.get(i),t)})}))}function Fe(n,e,t){const r=t?"outbound-rtp":"inbound-rtp",i=new Map;if(e===null)return i;const a=[];return n.forEach(f=>{f.type==="track"&&f.trackIdentifier===e.id&&a.push(f)}),a.forEach(f=>{n.forEach(d=>{d.type===r&&d.trackId===f.id&&pe(n,d,i)})}),i}const Ue=Be;function $e(n,e){const t=n&&n.navigator;if(!t.mediaDevices)return;const r=function(d){if(typeof d!="object"||d.mandatory||d.optional)return d;const S={};return Object.keys(d).forEach(m=>{if(m==="require"||m==="advanced"||m==="mediaSource")return;const y=typeof d[m]=="object"?d[m]:{ideal:d[m]};y.exact!==void 0&&typeof y.exact=="number"&&(y.min=y.max=y.exact);const b=function(P,_){return P?P+_.charAt(0).toUpperCase()+_.slice(1):_==="deviceId"?"sourceId":_};if(y.ideal!==void 0){S.optional=S.optional||[];let P={};typeof y.ideal=="number"?(P[b("min",m)]=y.ideal,S.optional.push(P),P={},P[b("max",m)]=y.ideal,S.optional.push(P)):(P[b("",m)]=y.ideal,S.optional.push(P))}y.exact!==void 0&&typeof y.exact!="number"?(S.mandatory=S.mandatory||{},S.mandatory[b("",m)]=y.exact):["min","max"].forEach(P=>{y[P]!==void 0&&(S.mandatory=S.mandatory||{},S.mandatory[b(P,m)]=y[P])})}),d.advanced&&(S.optional=(S.optional||[]).concat(d.advanced)),S},i=function(d,S){if(e.version>=61)return S(d);if(d=JSON.parse(JSON.stringify(d)),d&&typeof d.audio=="object"){const m=function(y,b,P){b in y&&!(P in y)&&(y[P]=y[b],delete y[b])};d=JSON.parse(JSON.stringify(d)),m(d.audio,"autoGainControl","googAutoGainControl"),m(d.audio,"noiseSuppression","googNoiseSuppression"),d.audio=r(d.audio)}if(d&&typeof d.video=="object"){let m=d.video.facingMode;m=m&&(typeof m=="object"?m:{ideal:m});const y=e.version<66;if(m&&(m.exact==="user"||m.exact==="environment"||m.ideal==="user"||m.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!y)){delete d.video.facingMode;let b;if(m.exact==="environment"||m.ideal==="environment"?b=["back","rear"]:(m.exact==="user"||m.ideal==="user")&&(b=["front"]),b)return t.mediaDevices.enumerateDevices().then(P=>{P=P.filter(I=>I.kind==="videoinput");let _=P.find(I=>b.some(A=>I.label.toLowerCase().includes(A)));return!_&&P.length&&b.includes("back")&&(_=P[P.length-1]),_&&(d.video.deviceId=m.exact?{exact:_.deviceId}:{ideal:_.deviceId}),d.video=r(d.video),Ue("chrome: "+JSON.stringify(d)),S(d)})}d.video=r(d.video)}return Ue("chrome: "+JSON.stringify(d)),S(d)},a=function(d){return e.version>=64?d:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[d.name]||d.name,message:d.message,constraint:d.constraint||d.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},f=function(d,S,m){i(d,y=>{t.webkitGetUserMedia(y,S,b=>{m&&m(a(b))})})};if(t.getUserMedia=f.bind(t),t.mediaDevices.getUserMedia){const d=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(S){return i(S,m=>d(m).then(y=>{if(m.audio&&!y.getAudioTracks().length||m.video&&!y.getVideoTracks().length)throw y.getTracks().forEach(b=>{b.stop()}),new DOMException("","NotFoundError");return y},y=>Promise.reject(a(y))))}}}function Qe(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function Ye(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=r=>{r.stream.addEventListener("addtrack",i=>{let a;n.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(d=>d.track&&d.track.id===i.track.id):a={track:i.track};const f=new Event("track");f.track=i.track,f.receiver=a,f.transceiver={receiver:a},f.streams=[r.stream],this.dispatchEvent(f)}),r.stream.getTracks().forEach(i=>{let a;n.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(d=>d.track&&d.track.id===i.id):a={track:i};const f=new Event("track");f.track=i,f.receiver=a,f.transceiver={receiver:a},f.streams=[r.stream],this.dispatchEvent(f)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else J(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Xe(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const e=function(i,a){return{track:a,get dtmf(){return this._dtmf===void 0&&(a.kind==="audio"?this._dtmf=i.createDTMFSender(a):this._dtmf=null),this._dtmf},_pc:i}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(d,S){let m=i.apply(this,arguments);return m||(m=e(this,d),this._senders.push(m)),m};const a=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(d){a.apply(this,arguments);const S=this._senders.indexOf(d);S!==-1&&this._senders.splice(S,1)}}const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(a){this._senders=this._senders||[],t.apply(this,[a]),a.getTracks().forEach(f=>{this._senders.push(e(this,f))})};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(a){this._senders=this._senders||[],r.apply(this,[a]),a.getTracks().forEach(f=>{const d=this._senders.find(S=>S.track===f);d&&this._senders.splice(this._senders.indexOf(d),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(i=>i._pc=this),r},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function we(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const a=t.apply(this,[]);return a.forEach(f=>f._pc=this),a});const r=n.RTCPeerConnection.prototype.addTrack;r&&(n.RTCPeerConnection.prototype.addTrack=function(){const a=r.apply(this,arguments);return a._pc=this,a}),n.RTCRtpSender.prototype.getStats=function(){const a=this;return this._pc.getStats().then(f=>Fe(f,a.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const i=t.apply(this,[]);return i.forEach(a=>a._pc=this),i}),J(n,"track",r=>(r.receiver._pc=r.srcElement,r)),n.RTCRtpReceiver.prototype.getStats=function(){const i=this;return this._pc.getStats().then(a=>Fe(a,i.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const r=arguments[0];let i,a,f;return this.getSenders().forEach(d=>{d.track===r&&(i?f=!0:i=d)}),this.getReceivers().forEach(d=>(d.track===r&&(a?f=!0:a=d),d.track===r)),f||i&&a?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():a?a.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Ze(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(f=>this._shimmedLocalStreams[f][0])};const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(f,d){if(!d)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const S=e.apply(this,arguments);return this._shimmedLocalStreams[d.id]?this._shimmedLocalStreams[d.id].indexOf(S)===-1&&this._shimmedLocalStreams[d.id].push(S):this._shimmedLocalStreams[d.id]=[d,S],S};const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(f){this._shimmedLocalStreams=this._shimmedLocalStreams||{},f.getTracks().forEach(m=>{if(this.getSenders().find(b=>b.track===m))throw new DOMException("Track already exists.","InvalidAccessError")});const d=this.getSenders();t.apply(this,arguments);const S=this.getSenders().filter(m=>d.indexOf(m)===-1);this._shimmedLocalStreams[f.id]=[f].concat(S)};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(f){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[f.id],r.apply(this,arguments)};const i=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(f){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},f&&Object.keys(this._shimmedLocalStreams).forEach(d=>{const S=this._shimmedLocalStreams[d].indexOf(f);S!==-1&&this._shimmedLocalStreams[d].splice(S,1),this._shimmedLocalStreams[d].length===1&&delete this._shimmedLocalStreams[d]}),i.apply(this,arguments)}}function et(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Ze(n);const t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const y=t.apply(this);return this._reverseStreams=this._reverseStreams||{},y.map(b=>this._reverseStreams[b.id])};const r=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(y){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},y.getTracks().forEach(b=>{if(this.getSenders().find(_=>_.track===b))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[y.id]){const b=new n.MediaStream(y.getTracks());this._streams[y.id]=b,this._reverseStreams[b.id]=y,y=b}r.apply(this,[y])};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(y){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[y.id]||y]),delete this._reverseStreams[this._streams[y.id]?this._streams[y.id].id:y.id],delete this._streams[y.id]},n.RTCPeerConnection.prototype.addTrack=function(y,b){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const P=[].slice.call(arguments,1);if(P.length!==1||!P[0].getTracks().find(A=>A===y))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(A=>A.track===y))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const I=this._streams[b.id];if(I)I.addTrack(y),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const A=new n.MediaStream([y]);this._streams[b.id]=A,this._reverseStreams[A.id]=b,this.addStream(A)}return this.getSenders().find(A=>A.track===y)};function a(m,y){let b=y.sdp;return Object.keys(m._reverseStreams||[]).forEach(P=>{const _=m._reverseStreams[P],I=m._streams[_.id];b=b.replace(new RegExp(I.id,"g"),_.id)}),new RTCSessionDescription({type:y.type,sdp:b})}function f(m,y){let b=y.sdp;return Object.keys(m._reverseStreams||[]).forEach(P=>{const _=m._reverseStreams[P],I=m._streams[_.id];b=b.replace(new RegExp(_.id,"g"),I.id)}),new RTCSessionDescription({type:y.type,sdp:b})}["createOffer","createAnswer"].forEach(function(m){const y=n.RTCPeerConnection.prototype[m],b={[m](){const P=arguments;return arguments.length&&typeof arguments[0]=="function"?y.apply(this,[I=>{const A=a(this,I);P[0].apply(null,[A])},I=>{P[1]&&P[1].apply(null,I)},arguments[2]]):y.apply(this,arguments).then(I=>a(this,I))}};n.RTCPeerConnection.prototype[m]=b[m]});const d=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?d.apply(this,arguments):(arguments[0]=f(this,arguments[0]),d.apply(this,arguments))};const S=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const m=S.get.apply(this);return m.type===""?m:a(this,m)}}),n.RTCPeerConnection.prototype.removeTrack=function(y){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!y._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(y._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let P;Object.keys(this._streams).forEach(_=>{this._streams[_].getTracks().find(A=>y.track===A)&&(P=this._streams[_])}),P&&(P.getTracks().length===1?this.removeStream(this._reverseStreams[P.id]):P.removeTrack(y.track),this.dispatchEvent(new Event("negotiationneeded")))}}function le(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const r=n.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=i[t]})}function tt(n,e){J(n,"negotiationneeded",t=>{const r=t.target;if(!((e.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")&&r.signalingState!=="stable"))return t})}const Ge=Object.freeze(Object.defineProperty({__proto__:null,fixNegotiationNeeded:tt,shimAddTrackRemoveTrack:et,shimAddTrackRemoveTrackWithNative:Ze,shimGetSendersWithDtmf:Xe,shimGetUserMedia:$e,shimMediaStream:Qe,shimOnTrack:Ye,shimPeerConnection:le,shimSenderReceiverGetStats:we},Symbol.toStringTag,{value:"Module"}));function rt(n,e){const t=n&&n.navigator,r=n&&n.MediaStreamTrack;if(t.getUserMedia=function(i,a,f){ye("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(i).then(a,f)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const i=function(f,d,S){d in f&&!(S in f)&&(f[S]=f[d],delete f[d])},a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(f){return typeof f=="object"&&typeof f.audio=="object"&&(f=JSON.parse(JSON.stringify(f)),i(f.audio,"autoGainControl","mozAutoGainControl"),i(f.audio,"noiseSuppression","mozNoiseSuppression")),a(f)},r&&r.prototype.getSettings){const f=r.prototype.getSettings;r.prototype.getSettings=function(){const d=f.apply(this,arguments);return i(d,"mozAutoGainControl","autoGainControl"),i(d,"mozNoiseSuppression","noiseSuppression"),d}}if(r&&r.prototype.applyConstraints){const f=r.prototype.applyConstraints;r.prototype.applyConstraints=function(d){return this.kind==="audio"&&typeof d=="object"&&(d=JSON.parse(JSON.stringify(d)),i(d,"autoGainControl","mozAutoGainControl"),i(d,"noiseSuppression","mozNoiseSuppression")),f.apply(this,[d])}}}}function Qt(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(r){if(!(r&&r.video)){const i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Promise.reject(i)}return r.video===!0?r.video={mediaSource:e}:r.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(r)})}function nt(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function me(n,e){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const a=n.RTCPeerConnection.prototype[i],f={[i](){return arguments[0]=new(i==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}};n.RTCPeerConnection.prototype[i]=f[i]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[a,f,d]=arguments;return r.apply(this,[a||null]).then(S=>{if(e.version<53&&!f)try{S.forEach(m=>{m.type=t[m.type]||m.type})}catch(m){if(m.name!=="TypeError")throw m;S.forEach((y,b)=>{S.set(b,Object.assign({},y,{type:t[y.type]||y.type}))})}return S}).then(f,d)}}function it(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(a=>a._pc=this),i});const t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){const i=t.apply(this,arguments);return i._pc=this,i}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ot(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const r=e.apply(this,[]);return r.forEach(i=>i._pc=this),r}),J(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function st(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){ye("removeStream","removeTrack"),this.getSenders().forEach(r=>{r.track&&t.getTracks().includes(r.track)&&this.removeTrack(r)})})}function at(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function ct(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let r=arguments[1]&&arguments[1].sendEncodings;r===void 0&&(r=[]),r=[...r];const i=r.length>0;i&&r.forEach(f=>{if("rid"in f&&!/^[a-z0-9]{0,16}$/i.test(f.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in f&&!(parseFloat(f.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in f&&!(parseFloat(f.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const a=e.apply(this,arguments);if(i){const{sender:f}=a,d=f.getParameters();(!("encodings"in d)||d.encodings.length===1&&Object.keys(d.encodings[0]).length===0)&&(d.encodings=r,f.sendEncodings=r,this.setParametersPromises.push(f.setParameters(d).then(()=>{delete f.sendEncodings}).catch(()=>{delete f.sendEncodings})))}return a})}function dt(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){const r=e.apply(this,arguments);return"encodings"in r||(r.encodings=[].concat(this.sendEncodings||[{}])),r})}function ut(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function ft(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}const ze=Object.freeze(Object.defineProperty({__proto__:null,shimAddTransceiver:ct,shimCreateAnswer:ft,shimCreateOffer:ut,shimGetDisplayMedia:Qt,shimGetParameters:dt,shimGetUserMedia:rt,shimOnTrack:nt,shimPeerConnection:me,shimRTCDataChannel:at,shimReceiverGetStats:ot,shimRemoveStream:st,shimSenderGetStats:it},Symbol.toStringTag,{value:"Module"}));function pt(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(r){this._localStreams||(this._localStreams=[]),this._localStreams.includes(r)||this._localStreams.push(r),r.getAudioTracks().forEach(i=>e.call(this,i,r)),r.getVideoTracks().forEach(i=>e.call(this,i,r))},n.RTCPeerConnection.prototype.addTrack=function(r,...i){return i&&i.forEach(a=>{this._localStreams?this._localStreams.includes(a)||this._localStreams.push(a):this._localStreams=[a]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const r=this._localStreams.indexOf(t);if(r===-1)return;this._localStreams.splice(r,1);const i=t.getTracks();this.getSenders().forEach(a=>{i.includes(a.track)&&this.removeTrack(a)})})}}function lt(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(i=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(i))return;this._remoteStreams.push(i);const a=new Event("addstream");a.stream=i,this.dispatchEvent(a)})})}});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const r=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach(a=>{if(r._remoteStreams||(r._remoteStreams=[]),r._remoteStreams.indexOf(a)>=0)return;r._remoteStreams.push(a);const f=new Event("addstream");f.stream=a,r.dispatchEvent(f)})}),e.apply(r,arguments)}}}function mt(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype,t=e.createOffer,r=e.createAnswer,i=e.setLocalDescription,a=e.setRemoteDescription,f=e.addIceCandidate;e.createOffer=function(m,y){const b=arguments.length>=2?arguments[2]:arguments[0],P=t.apply(this,[b]);return y?(P.then(m,y),Promise.resolve()):P},e.createAnswer=function(m,y){const b=arguments.length>=2?arguments[2]:arguments[0],P=r.apply(this,[b]);return y?(P.then(m,y),Promise.resolve()):P};let d=function(S,m,y){const b=i.apply(this,[S]);return y?(b.then(m,y),Promise.resolve()):b};e.setLocalDescription=d,d=function(S,m,y){const b=a.apply(this,[S]);return y?(b.then(m,y),Promise.resolve()):b},e.setRemoteDescription=d,d=function(S,m,y){const b=f.apply(this,[S]);return y?(b.then(m,y),Promise.resolve()):b},e.addIceCandidate=d}function gt(n){const e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,r=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=i=>r(ht(i))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(r,i,a){e.mediaDevices.getUserMedia(r).then(i,a)}).bind(e))}function ht(n){return n&&n.video!==void 0?Object.assign({},n,{video:Ke(n.video)}):n}function vt(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection;n.RTCPeerConnection=function(r,i){if(r&&r.iceServers){const a=[];for(let f=0;f<r.iceServers.length;f++){let d=r.iceServers[f];d.urls===void 0&&d.url?(ye("RTCIceServer.url","RTCIceServer.urls"),d=JSON.parse(JSON.stringify(d)),d.urls=d.url,delete d.url,a.push(d)):a.push(r.iceServers[f])}r.iceServers=a}return new e(r,i)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function yt(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function St(n){const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(r){if(r){typeof r.offerToReceiveAudio<"u"&&(r.offerToReceiveAudio=!!r.offerToReceiveAudio);const i=this.getTransceivers().find(f=>f.receiver.track.kind==="audio");r.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):r.offerToReceiveAudio===!0&&!i&&this.addTransceiver("audio",{direction:"recvonly"}),typeof r.offerToReceiveVideo<"u"&&(r.offerToReceiveVideo=!!r.offerToReceiveVideo);const a=this.getTransceivers().find(f=>f.receiver.track.kind==="video");r.offerToReceiveVideo===!1&&a?a.direction==="sendrecv"?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":a.direction==="recvonly"&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):r.offerToReceiveVideo===!0&&!a&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function Ct(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}const Je=Object.freeze(Object.defineProperty({__proto__:null,shimAudioContext:Ct,shimCallbacksAPI:mt,shimConstraints:ht,shimCreateOfferLegacy:St,shimGetUserMedia:gt,shimLocalStreamsAPI:pt,shimRTCIceServerUrls:vt,shimRemoteStreamsAPI:lt,shimTrackEventTransceiver:yt},Symbol.toStringTag,{value:"Module"}));var fe={exports:{}},He;function Yt(){return He||(He=1,(function(n){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(r=>r.trim())},e.splitSections=function(t){return t.split(`
m=`).map((i,a)=>(a>0?"m="+i:i).trim()+`\r
`)},e.getDescription=function(t){const r=e.splitSections(t);return r&&r[0]},e.getMediaSections=function(t){const r=e.splitSections(t);return r.shift(),r},e.matchPrefix=function(t,r){return e.splitLines(t).filter(i=>i.indexOf(r)===0)},e.parseCandidate=function(t){let r;t.indexOf("a=candidate:")===0?r=t.substring(12).split(" "):r=t.substring(10).split(" ");const i={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let a=8;a<r.length;a+=2)switch(r[a]){case"raddr":i.relatedAddress=r[a+1];break;case"rport":i.relatedPort=parseInt(r[a+1],10);break;case"tcptype":i.tcpType=r[a+1];break;case"ufrag":i.ufrag=r[a+1],i.usernameFragment=r[a+1];break;default:i[r[a]]===void 0&&(i[r[a]]=r[a+1]);break}return i},e.writeCandidate=function(t){const r=[];r.push(t.foundation);const i=t.component;i==="rtp"?r.push(1):i==="rtcp"?r.push(2):r.push(i),r.push(t.protocol.toUpperCase()),r.push(t.priority),r.push(t.address||t.ip),r.push(t.port);const a=t.type;return r.push("typ"),r.push(a),a!=="host"&&t.relatedAddress&&t.relatedPort&&(r.push("raddr"),r.push(t.relatedAddress),r.push("rport"),r.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(r.push("tcptype"),r.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(r.push("ufrag"),r.push(t.usernameFragment||t.ufrag)),"candidate:"+r.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let r=t.substring(9).split(" ");const i={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),i.name=r[0],i.clockRate=parseInt(r[1],10),i.channels=r.length===3?parseInt(r[2],10):1,i.numChannels=i.channels,i},e.writeRtpMap=function(t){let r=t.payloadType;t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType);const i=t.channels||t.numChannels||1;return"a=rtpmap:"+r+" "+t.name+"/"+t.clockRate+(i!==1?"/"+i:"")+`\r
`},e.parseExtmap=function(t){const r=t.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const r={};let i;const a=t.substring(t.indexOf(" ")+1).split(";");for(let f=0;f<a.length;f++)i=a[f].trim().split("="),r[i[0].trim()]=i[1];return r},e.writeFmtp=function(t){let r="",i=t.payloadType;if(t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const a=[];Object.keys(t.parameters).forEach(f=>{t.parameters[f]!==void 0?a.push(f+"="+t.parameters[f]):a.push(f)}),r+="a=fmtp:"+i+" "+a.join(";")+`\r
`}return r},e.parseRtcpFb=function(t){const r=t.substring(t.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},e.writeRtcpFb=function(t){let r="",i=t.payloadType;return t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(a=>{r+="a=rtcp-fb:"+i+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+`\r
`}),r},e.parseSsrcMedia=function(t){const r=t.indexOf(" "),i={ssrc:parseInt(t.substring(7,r),10)},a=t.indexOf(":",r);return a>-1?(i.attribute=t.substring(r+1,a),i.value=t.substring(a+1)):i.attribute=t.substring(r+1),i},e.parseSsrcGroup=function(t){const r=t.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(i=>parseInt(i,10))}},e.getMid=function(t){const r=e.matchPrefix(t,"a=mid:")[0];if(r)return r.substring(6)},e.parseFingerprint=function(t){const r=t.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},e.getDtlsParameters=function(t,r){return{role:"auto",fingerprints:e.matchPrefix(t+r,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,r){let i="a=setup:"+r+`\r
`;return t.fingerprints.forEach(a=>{i+="a=fingerprint:"+a.algorithm+" "+a.value+`\r
`}),i},e.parseCryptoLine=function(t){const r=t.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const r=t.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,r){return e.matchPrefix(t+r,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,r){const i=e.matchPrefix(t+r,"a=ice-ufrag:")[0],a=e.matchPrefix(t+r,"a=ice-pwd:")[0];return i&&a?{usernameFragment:i.substring(12),password:a.substring(10)}:null},e.writeIceParameters=function(t){let r="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(r+=`a=ice-lite\r
`),r},e.parseRtpParameters=function(t){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},a=e.splitLines(t)[0].split(" ");r.profile=a[2];for(let d=3;d<a.length;d++){const S=a[d],m=e.matchPrefix(t,"a=rtpmap:"+S+" ")[0];if(m){const y=e.parseRtpMap(m),b=e.matchPrefix(t,"a=fmtp:"+S+" ");switch(y.parameters=b.length?e.parseFmtp(b[0]):{},y.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+S+" ").map(e.parseRtcpFb),r.codecs.push(y),y.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(y.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(d=>{r.headerExtensions.push(e.parseExtmap(d))});const f=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return r.codecs.forEach(d=>{f.forEach(S=>{d.rtcpFeedback.find(y=>y.type===S.type&&y.parameter===S.parameter)||d.rtcpFeedback.push(S)})}),r},e.writeRtpDescription=function(t,r){let i="";i+="m="+t+" ",i+=r.codecs.length>0?"9":"0",i+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=r.codecs.map(f=>f.preferredPayloadType!==void 0?f.preferredPayloadType:f.payloadType).join(" ")+`\r
`,i+=`c=IN IP4 0.0.0.0\r
`,i+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,r.codecs.forEach(f=>{i+=e.writeRtpMap(f),i+=e.writeFmtp(f),i+=e.writeRtcpFb(f)});let a=0;return r.codecs.forEach(f=>{f.maxptime>a&&(a=f.maxptime)}),a>0&&(i+="a=maxptime:"+a+`\r
`),r.headerExtensions&&r.headerExtensions.forEach(f=>{i+=e.writeExtmap(f)}),i},e.parseRtpEncodingParameters=function(t){const r=[],i=e.parseRtpParameters(t),a=i.fecMechanisms.indexOf("RED")!==-1,f=i.fecMechanisms.indexOf("ULPFEC")!==-1,d=e.matchPrefix(t,"a=ssrc:").map(P=>e.parseSsrcMedia(P)).filter(P=>P.attribute==="cname"),S=d.length>0&&d[0].ssrc;let m;const y=e.matchPrefix(t,"a=ssrc-group:FID").map(P=>P.substring(17).split(" ").map(I=>parseInt(I,10)));y.length>0&&y[0].length>1&&y[0][0]===S&&(m=y[0][1]),i.codecs.forEach(P=>{if(P.name.toUpperCase()==="RTX"&&P.parameters.apt){let _={ssrc:S,codecPayloadType:parseInt(P.parameters.apt,10)};S&&m&&(_.rtx={ssrc:m}),r.push(_),a&&(_=JSON.parse(JSON.stringify(_)),_.fec={ssrc:S,mechanism:f?"red+ulpfec":"red"},r.push(_))}}),r.length===0&&S&&r.push({ssrc:S});let b=e.matchPrefix(t,"b=");return b.length&&(b[0].indexOf("b=TIAS:")===0?b=parseInt(b[0].substring(7),10):b[0].indexOf("b=AS:")===0?b=parseInt(b[0].substring(5),10)*1e3*.95-2e3*8:b=void 0,r.forEach(P=>{P.maxBitrate=b})),r},e.parseRtcpParameters=function(t){const r={},i=e.matchPrefix(t,"a=ssrc:").map(d=>e.parseSsrcMedia(d)).filter(d=>d.attribute==="cname")[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);const a=e.matchPrefix(t,"a=rtcp-rsize");r.reducedSize=a.length>0,r.compound=a.length===0;const f=e.matchPrefix(t,"a=rtcp-mux");return r.mux=f.length>0,r},e.writeRtcpParameters=function(t){let r="";return t.reducedSize&&(r+=`a=rtcp-rsize\r
`),t.mux&&(r+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(r+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),r},e.parseMsid=function(t){let r;const i=e.matchPrefix(t,"a=msid:");if(i.length===1)return r=i[0].substring(7).split(" "),{stream:r[0],track:r[1]};const a=e.matchPrefix(t,"a=ssrc:").map(f=>e.parseSsrcMedia(f)).filter(f=>f.attribute==="msid");if(a.length>0)return r=a[0].value.split(" "),{stream:r[0],track:r[1]}},e.parseSctpDescription=function(t){const r=e.parseMLine(t),i=e.matchPrefix(t,"a=max-message-size:");let a;i.length>0&&(a=parseInt(i[0].substring(19),10)),isNaN(a)&&(a=65536);const f=e.matchPrefix(t,"a=sctp-port:");if(f.length>0)return{port:parseInt(f[0].substring(12),10),protocol:r.fmt,maxMessageSize:a};const d=e.matchPrefix(t,"a=sctpmap:");if(d.length>0){const S=d[0].substring(10).split(" ");return{port:parseInt(S[0],10),protocol:S[1],maxMessageSize:a}}},e.writeSctpDescription=function(t,r){let i=[];return t.protocol!=="DTLS/SCTP"?i=["m="+t.kind+" 9 "+t.protocol+" "+r.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+r.port+`\r
`]:i=["m="+t.kind+" 9 "+t.protocol+" "+r.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+r.port+" "+r.protocol+` 65535\r
`],r.maxMessageSize!==void 0&&i.push("a=max-message-size:"+r.maxMessageSize+`\r
`),i.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,r,i){let a;const f=r!==void 0?r:2;return t?a=t:a=e.generateSessionId(),`v=0\r
o=`+(i||"thisisadapterortc")+" "+a+" "+f+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,r){const i=e.splitLines(t);for(let a=0;a<i.length;a++)switch(i[a]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[a].substring(2)}return r?e.getDirection(r):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const i=e.splitLines(t)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(t){const i=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const r=e.splitLines(t);for(let i=0;i<r.length;i++)if(r[i].length<2||r[i].charAt(1)!=="=")return!1;return!0},n.exports=e})(fe)),fe.exports}var Tt=Yt();const W=qt(Tt),Xt=Wt({__proto__:null,default:W},[Tt]);function Z(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const e=n.RTCIceCandidate;n.RTCIceCandidate=function(r){if(typeof r=="object"&&r.candidate&&r.candidate.indexOf("a=")===0&&(r=JSON.parse(JSON.stringify(r)),r.candidate=r.candidate.substring(2)),r.candidate&&r.candidate.length){const i=new e(r),a=W.parseCandidate(r.candidate);for(const f in a)f in i||Object.defineProperty(i,f,{value:a[f]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new e(r)},n.RTCIceCandidate.prototype=e.prototype,J(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function ge(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||J(n,"icecandidate",e=>{if(e.candidate){const t=W.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function ee(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(d){if(!d||!d.sdp)return!1;const S=W.splitSections(d.sdp);return S.shift(),S.some(m=>{const y=W.parseMLine(m);return y&&y.kind==="application"&&y.protocol.indexOf("SCTP")!==-1})},r=function(d){const S=d.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(S===null||S.length<2)return-1;const m=parseInt(S[1],10);return m!==m?-1:m},i=function(d){let S=65536;return e.browser==="firefox"&&(e.version<57?d===-1?S=16384:S=2147483637:e.version<60?S=e.version===57?65535:65536:S=2147483637),S},a=function(d,S){let m=65536;e.browser==="firefox"&&e.version===57&&(m=65535);const y=W.matchPrefix(d.sdp,"a=max-message-size:");return y.length>0?m=parseInt(y[0].substring(19),10):e.browser==="firefox"&&S!==-1&&(m=2147483637),m},f=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:S}=this.getConfiguration();S==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const S=r(arguments[0]),m=i(S),y=a(arguments[0],S);let b;m===0&&y===0?b=Number.POSITIVE_INFINITY:m===0||y===0?b=Math.max(m,y):b=Math.min(m,y);const P={};Object.defineProperty(P,"maxMessageSize",{get(){return b}}),this._sctp=P}return f.apply(this,arguments)}}function te(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function e(r,i){const a=r.send;r.send=function(){const d=arguments[0],S=d.length||d.size||d.byteLength;if(r.readyState==="open"&&i.sctp&&S>i.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+i.sctp.maxMessageSize+" bytes)");return a.apply(r,arguments)}}const t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const i=t.apply(this,arguments);return e(i,this),i},J(n,"datachannel",r=>(e(r.channel,r.target),r))}function he(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const r=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=i=>{const a=i.target;if(a._lastConnectionState!==a.connectionState){a._lastConnectionState=a.connectionState;const f=new Event("connectionstatechange",i);a.dispatchEvent(f)}return i},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function ve(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e._safariVersion>=13.1)return;const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const a=i.sdp.split(`
`).filter(f=>f.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&i instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:i.type,sdp:a}):i.sdp=a}return t.apply(this,arguments)}}function re(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function ne(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return t.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer";break}return i.sdp||i.type!=="offer"&&i.type!=="answer"?t.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(f=>t.apply(this,[f]))})}const wt=Object.freeze(Object.defineProperty({__proto__:null,removeExtmapAllowMixed:ve,shimAddIceCandidateNullOrEmpty:re,shimConnectionState:he,shimMaxMessageSize:ee,shimParameterlessSetLocalDescription:ne,shimRTCIceCandidate:Z,shimRTCIceCandidateRelayProtocol:ge,shimSendThrowTypeError:te},Symbol.toStringTag,{value:"Module"}));function Zt({window:n}={},e={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const t=Be,r=$t(n),i={browserDetails:r,commonShim:wt,extractVersion:K,disableLog:Bt,disableWarnings:Kt,sdp:Xt};switch(r.browser){case"chrome":if(!Ge||!le||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),i;if(r.version===null)return t("Chrome shim can not determine version, not shimming."),i;t("adapter.js shimming chrome."),i.browserShim=Ge,re(n,r),ne(n),$e(n,r),Qe(n),le(n,r),Ye(n),et(n,r),Xe(n),we(n),tt(n,r),Z(n),ge(n),he(n),ee(n,r),te(n),ve(n,r);break;case"firefox":if(!ze||!me||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),i;t("adapter.js shimming firefox."),i.browserShim=ze,re(n,r),ne(n),rt(n,r),me(n,r),nt(n),st(n),it(n),ot(n),at(n),ct(n),dt(n),ut(n),ft(n),Z(n),he(n),ee(n,r),te(n);break;case"safari":if(!Je||!e.shimSafari)return t("Safari shim is not included in this adapter release."),i;t("adapter.js shimming safari."),i.browserShim=Je,re(n,r),ne(n),vt(n),St(n),mt(n),pt(n),lt(n),yt(n),gt(n),Ct(n),Z(n),ge(n),ee(n,r),te(n),ve(n,r);break;default:t("Unsupported browser!");break}return i}const er=Zt({window:typeof window>"u"?void 0:window});function tr(n,e,t,r){let i=null,a=null;function f(){t("connecting"),w.init({debug:"all",dependencies:w.useDefaultDependencies({adapter:er}),callback:()=>{i=new w({server:n,iceServers:[{urls:"stun:janus.enabler.space:3478"},{urls:"turn:janus.enabler.space:3478",username:"janususer",credential:"januspassword"}],success:()=>{d()},error:P=>{t("error",String(P))},destroyed:()=>{t("stopped")}})}})}function d(){i&&i.attach({plugin:"janus.plugin.streaming",success:P=>{a=P,S()},error:P=>{t("error",String(P))},onmessage:(P,_)=>{if(P.error){t("error",P.error);return}if(P.result?.status){const I=P.result.status;I==="starting"||I==="started"?t("connected"):I==="stopped"&&t("stopped")}_&&a?.createAnswer({jsep:_,tracks:[{type:"audio",capture:!1,recv:!0}],customizeSdp:I=>{I.sdp&&(I.sdp=I.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1"))},success:I=>{a?.send({message:{request:"start"},jsep:I})},error:I=>{t("error",String(I))}})},onremotetrack:(P,_,I)=>{if(!I||P.kind!=="audio")return;const A=new MediaStream([P]);w.attachMediaStream(e,A),e.play().catch(()=>{})},oncleanup:()=>{t("stopped")}})}function S(){if(a){if(r){m(r);return}a.send({message:{request:"list"},success:P=>{const _=P?.list;if(!_||_.length===0){t("error","No streams available");return}m(_[0].id)}})}}function m(P){a?.send({message:{request:"watch",id:P}})}function y(){a&&(a.send({message:{request:"stop"}}),a.hangup()),e.srcObject=null,t("stopped")}function b(){a&&(a.detach(),a=null),i&&(i.destroy({cleanupHandles:!0}),i=null)}return{connect:f,disconnect:y,destroy:b}}var rr=kt('<button class="flex items-center gap-1.5 text-sm text-gallery-600 transition-colors hover:text-gallery-900 lg:gap-2 lg:text-base"><span> </span> <span></span></button> <audio class="hidden"></audio>',1);function nr(n,e){At(e,!0);const t="wss://janus.enabler.space/janus",r=je.PUBLIC_JANUS_STREAM_ID?Number(je.PUBLIC_JANUS_STREAM_ID):10;let i=Oe("idle"),a=Oe(void 0),f=null;function d(U,B){ke(i,U,!0)}function S(){V(a)&&(V(i)==="connected"||V(i)==="connecting"?(f?.disconnect(),f=null):(f=tr(t,V(a),d,r),f.connect()))}Lt(()=>{f?.destroy()});const m=Ne(()=>V(i)==="connected"?"bg-green-500":V(i)==="connecting"?"bg-amber-400 animate-pulse":V(i)==="error"?"bg-red-500":"bg-gallery-400"),y=Ne(()=>V(i)==="connected"?"Live":V(i)==="connecting"?"Connecting":"Listen");var b=rr(),P=Nt(b);P.__click=S;var _=Le(P),I=Le(_),A=Ae(_,2),k=Ae(P,2);Ht(k,U=>ke(a,U),()=>V(a)),jt(()=>{zt(P,"aria-label",V(i)==="connected"||V(i)==="connecting"?"Disconnect live audio":"Connect live audio"),Gt(I,V(y)),Jt(A,1,`inline-block h-2 w-2 rounded-full lg:h-3 lg:w-3 ${V(m)??""}`)}),Vt(n,b),Ft()}Ut(["click"]);nr.__docgen={data:[],name:"LiveAudioToggle.svelte"};export{nr as default};
